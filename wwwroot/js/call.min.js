var preventToChangePage=!1,isScreenSendAgain=!1,conferenceCallCount=($(".page1").hide(),$(".page2").hide(),$(".page3").hide(),$(".page4").hide(),0);function CallingModal_Ringing_AcceptCall(){ringsound.volume=0,ringsound.loop=!0,ringsound.pause(),ringsound.currentTime=0,dt1=new Date,$(".page4 .txt-timer").eq(0).attr("st",dt1),$(".page4 .txt-timer").eq(1).attr("st",dt1),$.post("/Home/CallLogUpdate",{Status:2,ToUser:mySignalRListener.callingUser.userId},function(){}),0==isVideoCall?$(".two-img").removeClass("hideinmobile"):$(".two-img").addClass("hideinmobile"),isConferenceCall()?mySignalRListener.AnswerCallNewMember(!0,mySignalRListener.callingUser):mySignalRListener.AnswerCall(!0,mySignalRListener.callingUser),$("body").attr("data-mode","incall"),$(".page1").hide(),$(".page2").hide(),$(".page4").hide(),$(".page3").show(),$("#callstatus").text("In Call"),$("#CallingModal img.me").attr("src",myprofilepic),$("#CallingModal label.me").html(myname),0<$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"]').length?($("#CallingModal .page1 img.other, #CallingModal .page2 img.other, #CallingModal .page3 img.other").attr("src",$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")),$("#CallingModal .page4 img.other").eq(0).attr("src",$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")),$("#CallingModal h3.other").eq(0).html($('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] label.name').text()),$("#CallingModal .row.blur-img").css("background-image","url('"+$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")+"')"),$("#CallingModal label.other").eq(0).html($('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] label.name').text())):($("#CallingModal .page1 img.other, #CallingModal .page2 img.other, #CallingModal .page3 img.other").attr("src",""),$("#CallingModal .page4 img.other").eq(0).attr("src",""),$("#CallingModal h3.other").eq(0).html(""),$.post("/Home/GetUserPicAndName",{uid:mySignalRListener.callingUser.userId},function(e){$("#CallingModal .page1 img.other, #CallingModal .page2 img.other, #CallingModal .page3 img.other").attr("src",e.profilePic),$("#CallingModal .page4 img.other").eq(0).attr("src",e.profilePic),$("#CallingModal h3.other").eq(0).html(e.firstName+" "+e.lastName),$("#CallingModal label.other").eq(0).html(e.firstName+" "+e.lastName),$("#CallingModal .row.blur-img").css("background-image","url('"+e.profilePic+"')")})),dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),sendStreamToOthers()}function sendStreamToOthers(){if(a=$("body").attr("data-json"))for(var e,a=JSON.parse(a),l=mySignalRListener.getFirstCurrentCallid(),i=0;i<a.length;i++)a[i].userid==myUserId||a[i].callid||(e=uuidv4(),a[i].callid=e,a.push({userid:myUserId,st:a[i].st,isCaller:!0,callid:e}),$("body").attr("data-json",JSON.stringify(a)),mySignalRListener.OtherMemberSendRequirement(e,a[i].connectionId,l))}function isConferenceCall(){var e=$("body").attr("data-json");return!!(e&&2<JSON.parse(e).length)}function CallingModal_RejectCall(){try{JSBridge.InvokeSignalR("AnswerCall",!1,mySignalRListener.callingUser)}catch(e){}$(".hangup").trigger("click"),$("#GotoCall").addClass("active"),$(window).unbind("beforeunload")}function CallingModal_Mute(e){localStream&&(localStream.getAudioTracks()[0].enabled=!localStream.getAudioTracks()[0].enabled,localStream.getAudioTracks()[0].enabled?e.children().eq(0).removeClass("active"):e.children().eq(0).addClass("active"))}$("#CallingModal .btn-sharescreen").on("click",async function(){isScreenSendAgain=!1,await CallingModal_InCall_ShareScreen()}),$("#CallingModal .switch-cam").on("click",async function(){await CallingModal_InCall_SwitchCam()}),$("#CallingModal .views").on("click",function(){CallingModal_InCall_ChangeViews()}),$(".page1 .btn-accept-call").on("click",function(){CallingModal_Ringing_AcceptCall()}),$(".page1 .btn-reject-call , .page2 .btn-reject-call, .page3 .btn-reject-call , .page4 .end-group-call").on("click",function(){CallingModal_RejectCall(),$("#GotoCall").removeClass("active"),ringsound.volume=0,ringsound.loop=!0,ringsound.pause(),ringsound.currentTime=0}),$(".btn-mute").on("click",function(){CallingModal_Mute($(this))}),$(".btn-speaker").on("click",async function(){await CallingModal_Speaker($(this))}),$("#CallingModal .btn-video").on("click",function(){CallingModal_InCall_ToggleVideo()}),$(".btn-conference-page").on("click",function(){CallingModal_InCall_ConferencePage()}),$(".btn-add-person").on("click",function(){CallingModal_InCall_AddMember()}),$(".btn-messages").on("click",function(){CallingModal_InCall_GoToChat()}),$("#GotoCall").on("click",function(){CallingModal_InCall_GoToCall()}),$(".page4 .title").on("click",function(){$(".page3").show(),$("#CallingModal .screen").show(),$(".page4").hide(),$("#CallingModal .video").addClass("active"),$("#CallingModal .video video").show()});var sinkId="";async function CallingModal_Speaker(e){var a=await navigator.mediaDevices.enumerateDevices();audioDevice=audioDevice=a.filter(e=>"audiooutput"===e.kind&&"default"!=e.deviceId),sinkId=(""==sinkId||sinkId==audioDevice[0].deviceId?1<audioDevice.length?audioDevice[1]:audioDevice[0]:2<audioDevice.length&&sinkId==audioDevice[1].deviceId?audioDevice[2]:3<audioDevice.length&&sinkId==audioDevice[1].deviceId?audioDevice[3]:audioDevice[0]).deviceId,e.children().eq(0).toggleClass("active"),await localaudio.setSinkId(sinkId)}function CallingModal_InCall_ChangeViews(){$("#CallingModal").hasClass("videos-in-right")||$("#CallingModal").hasClass("videos-in-left")||$("#CallingModal").hasClass("videos-in-bottom")||$("#CallingModal").hasClass("videos-datas-show")||$("#CallingModal").hasClass("videos-hide")?$("#CallingModal").hasClass("videos-hide")?($("#CallingModal").removeClass("videos-hide"),$("#CallingModal").addClass("videos-in-right")):$("#CallingModal").hasClass("videos-in-right")?($("#CallingModal").removeClass("videos-in-right"),$("#CallingModal").addClass("videos-in-left")):$("#CallingModal").hasClass("videos-in-left")?($("#CallingModal").removeClass("videos-in-left"),$("#CallingModal").addClass("videos-in-bottom")):$("#CallingModal").hasClass("videos-in-bottom")?($("#CallingModal").removeClass("videos-in-bottom"),$("#CallingModal").addClass("videos-datas-show")):$("#CallingModal").hasClass("videos-datas-show")&&($("#CallingModal").removeClass("videos-datas-show"),$("#CallingModal").addClass("videos-hide")):$("#CallingModal").addClass("videos-in-right")}async function CallingModal_InCall_SwitchCam(){localStream&&localStream.getTracks().forEach(e=>e.stop()),$("#CallingModal .video").eq(0).find("video").show(),isVideoCall=!0,localStream=null,facingModeStr="user"==facingModeStr?"environment":"user",webrtcConstraints=getVideoConfig(),initializeUserMediaVideo();var e=$("body").attr("data-json");if(e)for(var a,l,i=(e=JSON.parse(e)).filter(e=>!e.shareScreen),n=0;n<i.length;n++)i[n].userid!=myUserId&&(a=i[n].userid,l=i[n].connectionId,i[n].beforecallid=i[n].callid,i[n].callid=uuidv4(),$("body").attr("data-json",JSON.stringify(e)),replaceMyUserCallIdForToggleOrSwitchCamera(i[n].beforecallid,i[n].callid),createOfferWhenLocalStreamIsReady({callid:i[n].callid,connectionId:l,userId:a}))}var videoSinkid="";function replaceMyUserCallIdForToggleOrSwitchCamera(a,e){if(l=$("body").attr("data-json")){for(var l,i=(l=JSON.parse(l)).filter(e=>e.callid==a&&e.userid==myUserId),n=0;n<i.length;n++)i[n].callid=e,i[n].beforecallid=a;$("body").attr("data-json",JSON.stringify(l))}}function CallingModal_InCall_ToggleVideo(){$(".two-img").addClass("hideinmobile"),$("#CallingModal .video").eq(0).hasClass("active")?$("#CallingModal .video").eq(0).removeClass("active"):$("#CallingModal .video").eq(0).addClass("active"),localStream&&localStream.getTracks().forEach(e=>e.stop()),localStream=null,($("#CallingModal .video").eq(0).hasClass("active")?($("#CallingModal .video").eq(0).find("video").show(),isVideoCall=!0,initializeUserMediaVideo):($("#CallingModal .video").eq(0).find("video").hide(),isVideoCall=!1,initializeUserMediaVoice))();var e=$("body").attr("data-json");if(e)for(var a,l,i=(e=JSON.parse(e)).filter(e=>!e.shareScreen),n=0;n<i.length;n++)i[n].userid!=myUserId&&(a=i[n].userid,l=i[n].connectionId,i[n].beforecallid=i[n].callid,i[n].callid=uuidv4(),$("body").attr("data-json",JSON.stringify(e)),replaceMyUserCallIdForToggleOrSwitchCamera(i[n].beforecallid,i[n].callid),createOfferWhenLocalStreamIsReady({callid:i[n].callid,connectionId:l,userId:a}))}function CallingModal_InCall_ConferencePage(){$("#CallingModal .video").removeClass("active"),$("#CallingModal .video video").hide(),$("#CallingModal .screen").hide(),$(".page4").show(),$(".page3").hide()}function StopSharingScreen(){for(var e=localScreenStream.getTracks(),a=0;a<e.length;a++)e[a].stop();if(l=$("body").attr("data-json")){for(var l,i=(l=JSON.parse(l)).filter(e=>e.shareScreen&&e.userid!=myUserId),n=[],a=0;a<i.length;a++)n.push({userid:i[a].userid,callid:i[a].callid});mySignalRListener.shareScreenStoped(n),localScreenStream=null,removeScreenSharingFromJson()}}async function CallingModal_InCall_ShareScreen(){var e=$("body").attr("data-json");if(e){if(0<(e=JSON.parse(e)).filter(e=>e.shareScreen&&e.isCaller&&e.userid==myUserId).length&&localScreenStream)return void StopSharingScreen();for(var a,l,i,n=e.filter(e=>!e.shareScreen),t=n.length-1;0<=t;t--)n[t].userid!=myUserId&&(a=n[t].userid,l=n[t].connectionId,i=uuidv4(),e.push({callid:i,connectionId:l,userid:a,shareScreen:!0,isCaller:!1}),e.push({callid:i,connectionId:l,userid:myUserId,shareScreen:!0,isCaller:!0}),$("body").attr("data-json",JSON.stringify(e)),0)}var o=e.filter(e=>e.shareScreen&&e.userid!=myUserId);mySignalRListener.SendOtherCallIdForShareScreen(o)}function ifSenderScreenSendAgain(){console.log("ifSenderScreenSendAgain started");var e,a=$("body").attr("data-json");a&&(e=(a=JSON.parse(a)).filter(e=>e.shareScreen&&e.userid==myUserId&&e.isCaller))&&0<e.length&&(a=a.filter(e=>!e.shareScreen),$("body").attr("data-json",JSON.stringify(a)),isScreenSendAgain=!0,CallingModal_InCall_ShareScreen())}async function processSecondStepOfShareScreen(){0==isScreenSendAgain&&await captureScreen();var e=$("body").attr("data-json");if(e)for(var a=(e=JSON.parse(e)).filter(e=>e.shareScreen),l=a.length-1;0<=l;l--)a[l].userid!=myUserId&&createOfferWhenLocalScreenStreamIsReady({callid:a[l].callid,connectionId:a[l].connectionId,userId:a[l].userid})}function CallingModal_InCall_AddMember(){$("#CallingModal").modal("hide"),$(".page3").children().eq(0).children().eq(2).find("h3").html("Participants"),openAllContact(function(e){fromNewChat=!0,$("#selectContactModal").modal("hide"),$(".contact").removeClass("active"),e.addClass("active");e.data("id");var a=e.data("id"),l=new Date,i=$("body").attr("data-json"),n=(i?(i=JSON.parse(i),(n=ul.filter(e=>e.userId==a))&&0<n.length?(t={connectionId:n[0].connectionId,st:l,userid:a,isCaller:!1,callid:uuidv4()},i.push(t),$("body").attr("data-json",JSON.stringify(i)),t.userId=a,mySignalRListener.NewMemberAndCaller(t)):($("#CallingModal").modal("show"),alertify.error("the user is offline now!",4))):(i=[],(n=ul.filter(e=>e.userId==a))&&0<n.length?(t={connectionId:n[0].connectionId,st:l,userId:a,isCaller:!1,callid:uuidv4()},i.push(t),$("body").attr("data-json",JSON.stringify(i)),t.userId=a,mySignalRListener.NewMemberAndCaller(t)):($("#CallingModal").modal("show"),alertify.error("the user is offline now!",4))),$("body").attr("data-json",JSON.stringify(i)),e.find("img").attr("src")),t=e.find("label").eq(0).text().split('"').join(""),i=`
                    <div class="persons" st="`+l+'" data-id="'+a+`">
                        <div>
                            <img src="`+n+`" class="rounded-circle img other" />
                            <label class="other">`+t+`</label>
                        </div>
                        <div>
                            <label class="txt-timer other" st="`+l+`"></label>
                        </div>
                    </div>`;0==$('.page4 .persons[data-id="'+a+'"]').length&&$(".page4 .btn-add-person").before(i),$(".page3").children().eq(0).children().eq(1).find(".text-success").html("Conference Call"),$("#CallingModal").modal("show")})}function CallingModal_InCall_RecordCall(){}function CallingModal_InCall_GoToChat(){$("#CallingModal").modal("hide"),$("#GotoCall").addClass("active")}function CallingModal_InCall_GoToCall(){$("#CallingModal").modal("show"),$("#GotoCall").addClass("active")}$("body").on("click",function(e){var a;preventToChangePage=!1,"idle"!==$("body").attr("data-mode")&&(a=$(e.target),"A"===e.target.tagName&&"#"!=$(e.target).attr("href")&&null!=$(e.target).attr("href")||0<a.parents("a").length&&"#"!=$(e.target).attr("href")&&null!=$(e.target).attr("href")||a.hasClass("pro-small")||0<a.parents(".pro-small").length)&&(e.preventDefault(),window.confirm("This action need reload page and your call must be ended! (You can see this page in another browser tab during the call!). Do you want to end your call?")?a.hasClass("pro-small")||0<a.parents(".pro-small").length?window.location.href="/Home/Profile?uid="+$(".contact.active").data("id")+"&IsGroup="+$(".contact.active").hasClass("grp"):a.hasClass("setting")||0<a.parents(".setting").length?window.location.href="/Identity/Account/Manage/Index":a.hasClass("chatpage")||0<a.parents(".chatpage").length?window.location.href="/":(e=("A"===e.target.tagName?a:a.parents("a").first()).attr("href"),window.location.href=e):preventToChangePage=!0)}),async function(){var e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind&&"default"!=e.deviceId);0!=e.length&&1!=e.length||$("#CallingModal .switch-cam").hide()}();