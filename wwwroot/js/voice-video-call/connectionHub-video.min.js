const isDebugging=!0;var isVideoCall=!1,peerConnectionConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]},webrtcConstraints=($(".hangup").click(function(){beepring.pause(),beepring.currentTime=0,beepring.volume=0,console.log("hangup...."),clearInterval(videoaudiotimer),"idle"!==$("body").attr("data-mode")&&(mySignalRListener.HangUp(),closeAllConnections(),$("#VideoCallModal").modal("hide"),$("body").attr("data-mode","idle"),$("#callstatus").text("Idle"),remoteStream=localStream=null)}),{audio:!0,video:{width:{exact:320},height:{exact:240}}}),webrtcVoiceConstraints={audio:!0,video:!1},streamInfo={applicationName:WOWZA_APPLICATION_NAME,streamName:WOWZA_STREAM_NAME,sessionId:WOWZA_SESSION_ID_EMPTY};const localVideo=document.getElementById("localVideo"),remoteVideo=document.getElementById("remoteVideo"),partnerAudio=document.querySelector(".audio.partner");var videoaudiotimer,dt1,WOWZA_STREAM_NAME=null,connections={},localStream=null;function timerDisplayFun(){var e=new Date-dt1,o=Math.floor(e/1e3%60),e=Math.floor(e/1e3/60);document.querySelector(".recording-timer-display label").innerHTML=(e<10?"0":"")+e.toString()+":"+(o<10?"0":"")+o.toString(),videoaudiotimer=setTimeout(timerDisplayFun,1e3)}remoteStream=null,attachMediaStream=e=>{console.log("OnPage: called attachMediaStream"),remoteStream=e.stream,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),isVideoCall?remoteVideo.srcObject=e.stream:partnerAudio.srcObject=e.stream};var beforeSignals=[];const receivedCandidateSignal=(e,o,n)=>{thisSignalReceiveBefore(e,o,n)||(beforeSignals.push({connection:e,partnerClientId:o,candidate:n}),console.log("WebRTC: adding full candidate"),e.addIceCandidate(new RTCIceCandidate(n),()=>console.log("WebRTC: added candidate successfully"),()=>console.log("WebRTC: cannot add candidate")))};function thisSignalReceiveBefore(e,o,n){for(var t=0;t<beforeSignals.length;t++)if(JSON.stringify(beforeSignals[t].connection)==JSON.stringify(e)&&beforeSignals[t].partnerClientId==o&&JSON.stringify(beforeSignals[t].candidate)==JSON.stringify(n))return!0;return!1}const receivedSdpSignal=(e,o,n)=>{console.log("connection: ",e),console.log("sdp",n),console.log("WebRTC: called receivedSdpSignal"),console.log("WebRTC: processing sdp signal"),e.setRemoteDescription(new RTCSessionDescription(n),()=>{console.log("WebRTC: set Remote Description"),"offer"==e.remoteDescription.type?createAnswerWhenVideoOrAudioIsReady(e,o):"answer"==e.remoteDescription.type&&console.log("WebRTC: remote Description type answer")},errorHandler)};function createAnswerWhenVideoOrAudioIsReady(o,n){null==localStream?setTimeout(function(){createAnswerWhenVideoOrAudioIsReady(o,n)},500):(console.log("WebRTC: remote Description type offer"),console.log("localStream:",localStream),o.addStream(localStream),console.log("WebRTC: added stream"),o.createAnswer().then(e=>{console.log("WebRTC: create Answer..."),o.setLocalDescription(e,()=>{console.log("WebRTC: set Local Description..."),console.log("connection.localDescription: ",o.localDescription),sendHubSignal(JSON.stringify({sdp:o.localDescription}),n)},errorHandler)},errorHandler))}const newSignal=(e,o)=>{console.log("WebRTC: called newSignal");var o=JSON.parse(o),n=getConnection(e);console.log("connection: ",n),o.sdp?(console.log("WebRTC: sdp signal"),receivedSdpSignal(n,e,o.sdp)):o.candidate?(console.log("WebRTC: candidate signal"),receivedCandidateSignal(n,e,o.candidate)):(console.log("WebRTC: adding null candidate"),n.addIceCandidate(null,()=>console.log("WebRTC: added null candidate successfully"),()=>console.log("WebRTC: cannot add null candidate")))},onReadyForStream=e=>{console.log("WebRTC: called onReadyForStream"),e.addStream(localStream),console.log("WebRTC: added stream")},onStreamRemoved=(e,o)=>{console.log("WebRTC: onStreamRemoved -> Removing stream: ")},closeConnection=e=>{console.log("WebRTC: called closeConnection ");var o=connections[e];o&&(onStreamRemoved(null,null),localStream&&localStream.getTracks().forEach(function(e){e.stop()}),remoteStream&&remoteStream.getTracks().forEach(function(e){e.stop()}),$("#VideoCallModal").modal("hide"),o.close(),delete connections[e])},closeAllConnections=()=>{for(var e in console.log("WebRTC: call closeAllConnections "),connections)closeConnection(e);localStream&&localStream.getTracks().forEach(function(e){e.stop()}),remoteStream&&remoteStream.getTracks().forEach(function(e){e.stop()}),remoteStream=localStream=null},getConnection=e=>(console.log("WebRTC: called getConnection"),connections[e]?(console.log("WebRTC: connections partner client exist"),connections[e]):(console.log("WebRTC: initialize new connection"),initializeConnection(e))),initiateOffer=(o,e)=>{console.log("WebRTC: called initiateoffer: ");var n=getConnection(o);n.addStream(e),console.log("WebRTC: Added local stream"),n.createOffer().then(e=>{console.log("WebRTC: created Offer: "),console.log("WebRTC: Description after offer: ",e),n.setLocalDescription(e).then(()=>{console.log("WebRTC: set Local Description: "),console.log("connection before sending offer ",n),sendHubSignal(JSON.stringify({sdp:n.localDescription}),o)}).catch(e=>console.error("WebRTC: Error while setting local description",e))}).catch(e=>console.error("WebRTC: Error while creating offer",e))},callbackUserMediaSuccess=e=>{console.log("WebRTC: got media stream"),localStream=e,isVideoCall&&(localVideo.srcObject=e)},initializeUserMediaVideo=()=>{console.log("WebRTC: InitializeUserMedia: "),navigator.getUserMedia(webrtcConstraints,callbackUserMediaSuccess,errorHandler)},initializeUserMediaVoice=()=>{console.log("WebRTC: InitializeUserMedia: "),navigator.getUserMedia(webrtcVoiceConstraints,callbackUserMediaSuccess,errorHandler)},callbackRemoveStream=(e,o)=>{console.log("WebRTC: removing remote stream from partner window"),remoteVideo.srcObject=""},callbackAddStream=(e,o)=>{console.log("WebRTC: called callbackAddStream"),attachMediaStream(o)},callbackNegotiationNeeded=(e,o)=>{console.log("WebRTC: Negotiation needed...")},callbackIceCandidate=(e,o,n)=>{console.log("WebRTC: Ice Candidate callback"),e.candidate?(console.log("WebRTC: new ICE candidate"),sendHubSignal(JSON.stringify({candidate:e.candidate}),n)):(console.log("WebRTC: ICE candidate gathering complete"),sendHubSignal(JSON.stringify({candidate:null}),n))},initializeConnection=o=>{console.log("WebRTC: Initializing connection...");var n=new RTCPeerConnection(peerConnectionConfig);return n.oniceconnectionstatechange=function(){"disconnected"==n.iceConnectionState&&(console.log("Disconnected"),alertify.error("Sorry, you are disconnected.",5))},n.onicecandidate=e=>callbackIceCandidate(e,n,o),n.onaddstream=e=>callbackAddStream(n,e),n.onremovestream=e=>callbackRemoveStream(n,e),connections[o]=n};function createOfferWhenLocalStreamIsReady(e,o){try{null==o?setTimeout(function(){createOfferWhenLocalStreamIsReady(e,o)},500):(initiateOffer(e.connectionId,o),$("body").attr("data-mode","incall"),$("#ChatPmModal").modal("hide"),$("#callstatus").text("In Call"),console.log("signalr_callAccepted","end"))}catch(e){}}sendHubSignal=(e,o)=>{console.log("candidate",e),console.log("SignalR: called sendhubsignal "),mySignalRListener.SendSignal(e,o)};const errorHandler=e=>{(e.message?alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e.message)):alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e))).set({title:"ZN Vostok"}).set({delay:5e3}),consoleLogger(e)},consoleLogger=e=>{isDebugging&&console.log(e)};function SendNotConnectAlert(e){alertify.confirm(e,function(e){e&&window.location.reload(),sendNotConnectMess=!1}).set({title:"ZN Vostok"}).set("closable",!1).set("labels",{ok:"Refresh",cancel:"Wait for now"})}