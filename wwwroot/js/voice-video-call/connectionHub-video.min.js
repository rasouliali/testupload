const isDebugging=!0;var isVideoCall=!1,peerConnectionConfig={iceServers:[{url:"stun:stun.aliras.ir"},{urls:"turn:stun.aliras.ir",username:"AliRasouli",credential:"UJDEujDE@123321..!!"}]},facingModeStr=($(".hangup").click(function(){if(beepring.pause(),beepring.currentTime=0,beepring.volume=0,console.log("hangup...."),clearInterval(videoaudiotimer),"idle"!==$("body").attr("data-mode")){preventToChangePage=!1,$(window).unbind("beforeunload"),mySignalRListener.HangUp(),closeAllConnections(),$("#CallingModal").modal("hide"),$("body").attr("data-mode","idle"),$("#callstatus").text("Idle"),remoteStream2=remoteStream=localStream=null,localVideo.srcObject=null,remoteVideo.srcObject=null;for(var e=0;e<arrRemoteVideo.length;e++)arrRemoteVideo[e].stream=null,$("#remoteVideo"+arrRemoteVideo[e].num).removeClass("active"),$("#remoteVideo"+arrRemoteVideo[e].num)[0].srcObject=null;for(e=0;e<arrRemoteAudio.length;e++)arrRemoteAudio[e].stream=null,0<$("#partnerAudio"+arrRemoteAudio[e].num).length&&($("#partnerAudio"+arrRemoteAudio[e].num)[0].srcObject=null);if(arrRemoteVideo=[],arrRemoteAudio=[],localScreenStream){tracks=localScreenStream.getTracks();for(e=0;e<tracks.length;e++)tracks[e].stop()}resetVideoAudioCall()}$("body").removeAttr("data-json")}),"user");function getVideoConfig(){return{audio:!0,video:{width:{exact:320},height:{exact:240},facingMode:facingModeStr}}}async function startScreenSharing(){try{await navigator.mediaDevices.getDisplayMedia({video:!0})}catch(e){console.error("Error: Unable to access display media.",e)}}var webrtcConstraints=getVideoConfig(),webrtcVoiceConstraints={audio:!0,video:!1},streamInfo={applicationName:WOWZA_APPLICATION_NAME,streamName:WOWZA_STREAM_NAME,sessionId:WOWZA_SESSION_ID_EMPTY};const localaudio=document.getElementById("localaudio"),localVideo=document.getElementById("localVideo"),remoteVideo=document.getElementById("remoteVideo");var remoteDesktop=document.getElementById("remoteDesktop");const partnerAudio=document.querySelector(".audio.partner");var videoaudiotimer,arrRemoteVideo=[],arrRemoteAudio=[],WOWZA_STREAM_NAME=null,connections={},localStream=null,localScreenStream=null,remoteScreenStream=null,remoteStream=null,remoteStream2=null;function removeScreenSharingFromJson(){var e=$("body").attr("data-json");e&&(e=(e=JSON.parse(e)).filter(e=>!e.shareScreen),$("body").attr("data-json",JSON.stringify(e)))}async function captureScreen(){try{(localScreenStream=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!1})).onended=()=>{console.info("ScreenShare has ended")},localScreenStream.getVideoTracks()[0].onended=function(){console.info("ScreenShare has ended2"),StopSharingScreen()}}catch(e){console.log("Error occurred",e)}}attachMediaStream=(e,o)=>{var t,r,a,n;o.shareScreen?(remoteDesktop.srcObject=e.stream,(remoteScreenStream=e.stream).getVideoTracks()[0].onended=function(){remoteDesktop.srcObject=null,remoteScreenStream=null,removeScreenSharingFromJson(),$(".screen.remote").removeClass("active")},$(".screen.remote")[0].style.position="relative",$(".screen.remote").addClass("active"),$(".screen.remote").attr("data-userid",o.userId)):(console.log("attachMediaStream connection.userId:"+o.userId),t=(t=remoteVideo.getAttribute("data-userid"))||o.userId,n=(n=partnerAudio.getAttribute("data-userid"))||o.userId,"videoDivInvisible"==$(".video.i1").parent().attr("id")&&$(".video.i1").appendTo($("#videoDiv")),0<e.stream.getVideoTracks().length?o.userId==t?(console.log("attachMediaStream remoteVideo "),remoteStream=e.stream,remoteVideo.srcObject=e.stream,remoteVideo.setAttribute("data-userid",o.userId)):0<(r=arrRemoteVideo.filter(e=>e.userid==o.userId)).length?($("#remoteVideo"+r[0].num)[0].srcObject=e.stream,r[0].stream=e.stream,"videoDivInvisible"==$(".video.i"+r[0].num).parent().attr("id")&&$("#remoteVideo"+r[0].num).parent().appendTo($("#videoDiv"))):0==r.length&&(t=arrRemoteVideo.length+2,a="","none"==$(".page4")[0].style.display.toString()&&(a=" active"),arrRemoteVideo.push({userid:o.userId,num:t,stream:e.stream}),$("#CallingModal #videoDiv").append('<div class="video remote'+t+a+" i"+t+'"><video id="remoteVideo'+t+'" data-userid="'+o.userId+'" autoplay playsinline></video></div>'),$("#remoteVideo"+t)[0].srcObject=e.stream,console.log("attachMediaStream remoteVideo"+t),$("#remoteVideo"+t).on("click",function(){var e=$(this);fullScreenVideo(e)})):o.userId==n?(console.log("attachMediaStream remoteAudio"),remoteStream=e.stream,partnerAudio.srcObject=e.stream,partnerAudio.setAttribute("data-userid",o.userId)):0<(r=arrRemoteAudio.filter(e=>e.userid==o.userId)).length?($("#remoteAudio"+r[0].num)[0].srcObject=e.stream,r[0].stream=e.stream):0==r.length&&(a=arrRemoteAudio.length+2,arrRemoteAudio.push({userid:o.userId,num:a,stream:e.stream}),$("#CallingModal .modal-body").append('<audio class="audio partner" id="remoteAudio'+a+'" autoplay="" controls=""></audio>'),console.log("attachMediaStream partnerAudio"+a),$("#remoteAudio"+a)[0].srcObject=e.stream,$("#remoteAudio"+a)[0].setAttribute("data-userid",o.userId)))};var beforeSignals=[];const receivedCandidateSignal=(e,o,t)=>{thisSignalReceiveBefore(e,o,t)||(beforeSignals.push({connection:e,callid:o,candidate:t}),console.log("WebRTC: adding full candidate"),e.addIceCandidate(new RTCIceCandidate(t),()=>console.log("WebRTC: added candidate successfully"),()=>console.log("WebRTC: cannot add candidate")))};function thisSignalReceiveBefore(e,o,t){for(var r=0;r<beforeSignals.length;r++)if(JSON.stringify(beforeSignals[r].connection)==JSON.stringify(e)&&beforeSignals[r].partnerClientId==o&&JSON.stringify(beforeSignals[r].candidate)==JSON.stringify(t))return!0;return!1}const receivedSdpSignal=(e,o,t,r)=>{console.log("receivedSdpSignal callid: ",o,"connection.userId: ",e.userId),e.setRemoteDescription(new RTCSessionDescription(t),()=>{"offer"==e.remoteDescription.type?createAnswerWhenVideoOrAudioIsReady(e,o,r):e.remoteDescription.type},errorHandler)};function createAnswerWhenVideoOrAudioIsReady(o,t,e){null==localStream?setTimeout(function(){createAnswerWhenVideoOrAudioIsReady(o,t)},500):(console.log("WebRTC: remote Description type offer",", connection.userId:"+o.userId+", callid:"+t),e||o.addStream(localStream),o.createAnswer().then(e=>{console.log("WebRTC: create Answer..."),o.setLocalDescription(e,()=>{console.log("connection.localDescription: ",o.localDescription),sendHubSignal(JSON.stringify({sdp:o.localDescription}),t,o.userId)},e=>console.error("createAnswer error:",e))},errorHandler))}const newSignal=(e,o,t,r)=>{console.log("WebRTC: called newSignal",", callid:"+t,", userId:"+r);var a,o=JSON.parse(o),n=getConnection(t,r,o.shareScreen);o.sdp?(o.shareScreen&&(a=$("body").attr("data-json"))&&((a=JSON.parse(a)).push({callid:t,connectionId:e,userid:r,shareScreen:!0,isCaller:!0}),a.push({callid:t,userid:myUserId,shareScreen:!0,isCaller:!1}),$("body").attr("data-json",JSON.stringify(a))),console.log("WebRTC: sdp signal"),receivedSdpSignal(n,t,o.sdp,o.shareScreen)):o.candidate?(console.log("WebRTC: candidate signal"),receivedCandidateSignal(n,t,o.candidate)):(console.log("WebRTC: adding null candidate"),n.addIceCandidate(null,()=>console.log("WebRTC: added null candidate successfully"),()=>console.error("WebRTC error: cannot add null candidate")))},onReadyForStream=e=>{e.addStream(localStream)},onStreamRemoved=(e,o)=>{},closeConnection=e=>{var o=connections[e];o&&(o.userId==remoteVideo.getAttribute("data-userid")&&remoteVideo.removeAttribute("data-userid"),onStreamRemoved(null,null),o.close(),delete connections[e],o=removeCallidFromDataJson(e),localStream)&&0==o&&(localStream.getTracks().forEach(function(e){e.stop()}),$(".hangup").trigger("click"))};function removeCallidFromDataJson(e){if(o=$("body").attr("data-json")){for(var o,t=(o=JSON.parse(o)).length-1;0<=t;t--)o[t].callid==e&&o.splice(t,1);return $("body").attr("data-json",JSON.stringify(o)),o.length}return 0}const closeAllConnections=()=>{for(var e in console.log("WebRTC: call closeAllConnections "),connections)closeConnection(e);localStream&&localStream.getTracks().forEach(function(e){e.stop()}),remoteStream&&remoteStream.getTracks().forEach(function(e){e.stop()}),remoteStream2&&remoteStream2.getTracks().forEach(function(e){e.stop()}),remoteStream=localStream=null},getConnection=(e,o,t)=>connections[e]?(console.log("WebRTC: connections partner client exist"),connections[e]):(console.log("WebRTC: initialize new connection"),initializeConnection(e,o,t)),initiateOffer=(o,e,t,r,a)=>{console.log("WebRTC: called initiateoffer, callid:"+o+", userId:"+r);var n=getConnection(o,r);n.addStream(t),n.createOffer().then(e=>{n.setLocalDescription(e).then(()=>{var e={sdp:n.localDescription};a&&(e.shareScreen=!0),sendHubSignal(JSON.stringify(e),o,r,a)}).catch(e=>console.error("WebRTC: Error while setting local description",e,", connection.userId:"+n.userId,", callid:"+o))}).catch(e=>console.error("WebRTC: Error while creating offer",e))},callbackUserMediaSuccess=e=>{console.log("WebRTC: got media stream"),localStream=e,isVideoCall?localVideo.srcObject=e:localaudio.secObject=e},initializeUserMediaVideo=()=>{navigator.getUserMedia(webrtcConstraints,callbackUserMediaSuccess,errorHandler)},initializeUserMediaVoice=()=>{navigator.getUserMedia(webrtcVoiceConstraints,callbackUserMediaSuccess,errorHandler)},callbackRemoveStream=(e,o,t)=>{remoteVideo.srcObject=""},callbackAddStream=(e,o,t)=>{attachMediaStream(o,e)},callbackNegotiationNeeded=(e,o)=>{console.log("WebRTC: Negotiation needed...")},callbackIceCandidate=(e,o,t,r,a)=>{console.log("WebRTC: Ice Candidate callback"),e.candidate?(console.log("WebRTC: new ICE candidate"),sendHubSignal(JSON.stringify({candidate:e.candidate}),t,a)):(console.log("WebRTC: ICE candidate gathering complete"),sendHubSignal(JSON.stringify({candidate:null}),t,a))},initializeConnection=(o,t,e)=>{console.log("WebRTC: Initializing connection...");var r=new RTCPeerConnection(peerConnectionConfig);return r.oniceconnectionstatechange=function(e,o){console.log("oniceconnectionstatechange",e),"disconnected"==r.iceConnectionState&&(console.log("oniceconnectionstatechange Disconnected"),"idle"!=$("body").attr("data-mode"))&&(e=$('.page4 .persons[data-id="'+r.userId+'"]').find("div").eq(0).text(),alertify.error("Sorry, Your call to "+e+" was interrupted due to weak internet connection.",5),0==removeCallidFromDataJson(o))&&$(".hangup").trigger("click")},r.onicecandidate=e=>callbackIceCandidate(e,r,o,isCaller,t),r.onaddstream=e=>callbackAddStream(r,e,t),r.onremovestream=e=>callbackRemoveStream(r,e,t),r.userId=t,connections[o]=r,connections[o].shareScreen=e,r};function createOfferWhenLocalStreamIsReady(e){try{var o;null==localStream?setTimeout(function(){console.log("createOfferWhenLocalStreamIsReady","localStream is null yet"),createOfferWhenLocalStreamIsReady(e)},500):(o=mySignalRListener.getCallidByUserId(e.userId),initiateOffer(o,e.connectionId,localStream,e.userId,!1),$("body").attr("data-mode","incall"),$("#ChatPmModal").modal("hide"),$("#callstatus").text("In Call"))}catch(e){}}function createOfferWhenLocalScreenStreamIsReady(e){try{var o;null==localScreenStream?setTimeout(function(){console.log("createOfferWhenLocalScreenStreamIsReady","localScreenStream is null yet"),createOfferWhenLocalScreenStreamIsReady(e)},500):(o=e.callid,initiateOffer(o,e.connectionId,localScreenStream,e.userId,!0),$("body").attr("data-mode","incall"),$("#ChatPmModal").modal("hide"),$("#callstatus").text("In Call"))}catch(e){console.log("err createOfferWhenLocalScreenStreamIsReady",e)}}sendHubSignal=(e,o,t)=>{console.log("sendHubSignal callid:",o),mySignalRListener.SendSignal(e,o)};const errorHandler=e=>{(e.message?alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e.message)):alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e))).set({title:"ZN Vostok"}).set({delay:5e3}),consoleLogger(e)},consoleLogger=e=>{isDebugging&&console.log(e)};function SendNotConnectAlert(e){alertify.confirm(e,function(e){e&&window.location.reload(),sendNotConnectMess=!1}).set({title:"ZN Vostok"}).set("closable",!1).set("labels",{ok:"Refresh",cancel:"Wait for now"})}