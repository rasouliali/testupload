var signalRListenerThis,beforeCallId="",isCaller=!1;class signalRListener{constructor(){(signalRListenerThis=this).sendNotConnectMess=!1,this.isDebugging=!0,this.hubUrl="/ConnectionHub",this.wsconn=(new signalR.HubConnectionBuilder).withUrl(this.hubUrl,signalR.HttpTransportType.WebSockets).withAutomaticReconnect({nextRetryDelayInMilliseconds:e=>($(".chat h5.chatpage").html("ZN Vostok     Connecting..."),checkForRestartSignalR(),1e6)}).configureLogging(signalR.LogLevel.None).build(),this.initializeSignalR(),this.wsconn.onclose(e=>{$(".chat h5.chatpage").html("ZN Vostok     Connecting..."),e?(console.log("SignalR: closed with error."),console.log(e)):console.log("Disconnected"),checkForRestartSignalR()}),this.wsconn.on("updateUserList",s=>{$(".chat h5.chatpage").html("ZN Vostok"),s=JSON.parse(s),ul=s,$("#usersLength").text(s.length),$("#usersdata li.user").remove(),$(".contact img").removeClass("online"),$.each(s,function(e){var n="";s[e].username===$("#upperUsername").text()&&(myConnectionId=s[e].connectionId,n="icon-employee"),n||(s[e].inCall,n="icon-smartphone-1"),s[e].inCall,$('.contact[data-id="'+s[e].userId.toLowerCase()+'"] img').addClass("online")})}),this.wsconn.on("callAccepted",(e,n)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(console.log("SignalR: call accepted from: "+n+".  Initiating WebRTC call and offering my stream up..."),n=JSON.parse(n),$("#call-status-lbl").html("Call accepted..."),beepring.pause(),beepring.currentTime=0,beepring.volume=0,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),setTimeout(function(){$("#call-status-lbl").html("Connected")},3e3),createOfferWhenLocalStreamIsReady(n,localStream))})}),this.wsconn.on("callDeclined",(e,n,s)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(n=JSON.parse(n),console.log("SignalR: call declined from: "+n.connectionId),$("#call-status-lbl").html("Call Declined!"),beepring.pause(),beepring.currentTime=0,beepring.volume=0,alertify.error(s,5),setTimeout(function(){$(".hangup").trigger("click")},3e3))})}),this.wsconn.on("incomingCall",(n,s,t)=>{CheckDuplicateInLockBlock(n).then(function(e){if(e){if($("#call-status-lbl").html("Call started"),console.log("SignalR: incoming"+(isVideoCall?" video ":" voice ")+"call from: "+s),s=JSON.parse(s),isVideoCall=t,$(".partner")[0].style.display="none",0==isVideoCall?(localVideo.style.display="none",remoteVideo.style.display="none",$(".partner")[0].style.display="",$("#VideoCallModalLabel").html("Voice Call")):(localVideo.style.display="",remoteVideo.style.display="",$("#VideoCallModalLabel").html("Video Call")),isVideoCall)0==IsCameraPermission&&(IsCameraPermission=JSBridge.getVideoPermission());else try{0==IsMicrophonePermission&&JSBridge.getAudioPermission()}catch{}alertify.confirm(s.username+" is calling.  Do you want to"+(isVideoCall?" video ":" voice ")+"chat?",function(e){if(e){$("body").attr("data-call",n),isCaller=!1,(0==isVideoCall?initializeUserMediaVoice:initializeUserMediaVideo)(),dt1=new Date,$.post("/Home/CallLogUpdate",{Status:2,ToUser:s.userId},function(){}),$("#VideoCallModal").modal("show");try{mySignalRListener.AnswerCall(!0,s).catch(e=>console.log(e))}catch(e){}$("body").attr("data-mode","incall"),$("#callstatus").text("In Call")}else mySignalRListener.AnswerCall(!1,s).catch(e=>console.log(e))}).set({title:"ZN Vostok"}).set("closable",!1).set("labels",{ok:"Accept Call",cancel:"Reject Call"})}})}),this.wsconn.on("receiveSignal",(e,n,s)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(n=JSON.parse(n),newSignal(n.connectionId,s))})}),this.wsconn.on("callEnded",(e,n,s)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&($("#call-status-lbl").html("Call ended"),e=new Date-dt1,n=JSON.parse(n),$.post("/Home/CallLogUpdate",{Status:2,ToUser:n.userId,duration:e/1e3},function(){}),$("body").removeAttr("data-call"),setTimeout(function(){$(".hangup").trigger("click")},3e3),console.log("SignalR: call with "+n.connectionId+" has ended: "+s),alertify.error(s,5),beepring.pause(),beepring.currentTime=0,beepring.volume=0,closeConnection(n.connectionId),$("#callstatus").text("Idle"))})}),this.wsconn.on("OnSeenMess",(e,n)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&("all"==n?$("li span:not(.seen)"):$("li[data-id="+n+"] span")).addClass("seen")})}),this.wsconn.on("OnSeenMessForGroup",(e,n,s)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&("all"==s?$("li span:not(.seen)"):$("li[data-id="+s+"] span")).addClass("seen")})}),this.wsconn.on("ReceiveMessageFromGroup",(e,n,s,t)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&s.split(";;;")[1].toLowerCase()!=myUserId.toLowerCase()&&(console.log("ProcessReceiveMessege","message:"+s+",grpName:"+n+",ContactName:"+t),signalRListenerThis.ProcessReceiveMessege(s,n,t))})}),this.wsconn.on("ReceiveMessage",(e,n)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&signalRListenerThis.ProcessReceiveMessege(n)})})}ProcessReceiveMessege(e,n,s){notifring.play();var t,a,o=e.split(";;;")[1];if(e.startsWith("delmess;,;"))n?$(".contact[data-id="+n.toLowerCase()+"]").hasClass("active")&&(a=(t=e.replace("delmess;,;","").split(";;;")[0]).split(","),$.each(a,function(e,n){e=a[e];$("ul li[data-id="+e+"]").remove()})):$(".contact[data-id="+o+"]").hasClass("active")&&(t=e.replace("delmess;,;","").split(";;;")[0],$("ul li[data-id="+t+"]").remove());else if(e.startsWith("customNotif:"))try{var i=e.split(";;;")[3],l=e.split(";;;")[2],c=e.split(";;;")[4];JSBridge.setCustomNotification(l,c,parseInt(i))}catch{}else{if(n)null==(d=$(".contact[data-id="+n.toLowerCase()+"] .text-bg-success").html())&&this.appendNewContactById(n,!0);else if(null==(d=$(".contact[data-id="+o.toLowerCase()+"] .text-bg-success").html()))return void this.appendNewContactById(o);d?(l=parseInt(d.replace(" ","").replace("(","").replace(")","")),l++,$(".contact[data-id="+(n||o).toLowerCase()+"] .text-bg-success").html(l)):$(".contact[data-id="+(n||o).toLowerCase()+"] .text-bg-success").html("1");try{i=e.split(";;;")[3];JSBridge.setNotification("you have new message",i)}catch{}if($(".contact[data-id="+(n||o).toLowerCase()+"]").hasClass("active")){var r=new Date,c=e.split(";;;")[0],d=e.split(";;;")[2],u=(t=e.split(";;;")[3],e.split(";;;")[4]),g="";if("isfile"==c){var h=d.split(",;,")[0].split(";"),p="";1<d.split(",;,").length&&(p=d.split(",;,")[1]);for(var v=0;v<h.length;v++){g=g+('<li class="from-other" data-id="'+t+'" >')+(n?"<div class='name'>"+s+"</div>":""),p&&(g+='<div class="newcard" data-id="'+(u||"")+`" >
                          <div class="card-header" `+ForwardSenderId(p)+">"+p.split(",@,")[0]+"</div>");var m=document.createTextNode(h[v].split("\\\\").join("\\"));h[v]=m.textContent,IsImage(h[v])?g+='<label><a data-url="/Home/GetFile?fileName='+h[v]+'&fileType=up" class="img-tag"><div><img  class="fupload" src="/Home/GetFile?fileName='+h[v]+'&fileType=up&th=true" /></div><div>'+h[v]+"</div></a></label>":IsAudio(h[v])?g+='<label><div><audio controls src="/Home/GetFile?fileName='+h[v]+'&fileType=up" ></audio></div><div> '+h[v]+"</div></label>":IsVideo(h[v])?g+='<label><div><video controls  ><source src="/Home/GetFile?fileName='+h[v]+'&fileType=up" ></video></div><div> '+h[v]+"</div></label>":IsPdfOrDoc(h[v])?g+='<label><a href="/Home/GetFile?fileName='+h[v]+'&fileType=up" target="_blank" ><div><img class="docpdfimg" src="/Home/GetFile?fileName='+h[v].substring(0,h[v].lastIndexOf("."))+'.jpg&fileType=up&th=true" /></div><div>'+h[v]+"</div></a></label>":g+='<label><a href="/Home/GetFile?fileName='+h[v]+'&fileType=up" target="_blank" ><div><img src="/img/file-icon.png" /></div><div>'+h[v]+"</div></a></label>",p&&(g+="</div>"),g+='</li><li  class="from-other"><div class="date">'+getNiceDateTimeFormat(r)+"</div></li>"}}else g+='<li class="from-other"  data-id="'+t+'" >'+(n?"<div class='name'>"+s+"</div>":"")+(0<=d.indexOf(",;,")?'<div class="newcard" data-id="'+(u||"")+`" >
                          <div class="card-header">`+d.split(",;,")[0]+"</div><label "+checkRtlOfText(d.split(",;,")[1])+">"+textToWrite(d.split(",;,")[1])+"</label></div>":"<label"+checkRtlOfText(d)+">"+textToWrite(d)+"</label>")+'</li><li  class="from-other"><div class="date">'+getNiceDateTimeFormat(c)+"</div></li>";n?this.SeenMessegeForGroup(t,o,n):this.SeenMessege(t,o),setTimeout(function(){$("#lastchat").before(g)},500),$("li .newcard:not(.card) .card-header").on("click",function(){var e=$(this).parent().data("id");$(".chat-pm ul").scrollTop($('[data-id="'+e+'"]').get(0).offsetTop-90),$('[data-id="'+e+'"]').eq(0).css("background","black"),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","transparent")},500),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","black")},1e3),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","transparent")},1500)}),$("li .newcard:not(.card)").addClass("card"),setTimeout(function(){$(".chat-pm ul").scrollTop($(".chat-pm ul").get(0).scrollHeight)},500),loadForSelectLi(),$(".img-tag").unbind("click"),$(".img-tag").on("click",function(){var e=$(this).data("url");loadImageModal(e)})}}}appendNewContactById(e,n){$.post("/Home/GetAccounts",{searchKey:e},function(e){if(0!=e.length){$(".no-mess-contact").hide();for(var n=0;n<e.length;n++){var s=e[n].contactName||e[n].userName,t=e[n].profilePic?"/ProfilePics/thumbnails/"+e[n].profilePic:e[n].isGroup?"/img/group-icon.png":"/img/person-icon.png",t='<div class="mess row contact new-def-mess def-mess" minid="'+e[n].minid+'" data-id="'+e[n].userId+`">
                                    <div class="col-12 d-inline px-3">
                                        <div class="float-start">
                                            <img src="`+t+`" class="img-pro online">
                                        </div>
                                        <div class="float-start text-start px-2">
                                            <div class="pro">
                                                    <label class="name">`+s+`</label>
                                                    <label class="company">`+e[n].companyTitle+`</label>
                                                    <label class="role">`+e[n].position+`</label>
                                            </div>
                                        </div>
                                        <div class="float-end chat-num">
                                            <label class="badge text-bg-success">1</label>
                                        </div>
                                    </div>
                                </div>`;$(".contacts").children().first().before(t),$(".new-def-mess").on("click",function(){$(".contact").removeClass("new-def-mess"),$(".contact").removeClass("active"),$(this).addClass("active");var e=$(this).data("id");$(".loading").show(),$(this).data("id");$.post("/Home/GetContactMessage",{minId:"0",contactId:e},function(e){$(".loading").hide(),null==e||0==e.length?SetEmptyMessage():SetResultOfMessage(e)})}),$(".new-def-mess").addClass("def-mess").removeClass("new-def-mess")}}})}initializeSignalR(){this.wsconn.start().then(()=>{$(".chat h5.chatpage").html("ZN Vostok"),console.log("SignalR: Connected"),this.setUsername(myusername),this.setNewCallInfo()}).catch(e=>{$(".chat h5.chatpage").html("ZN Vostok     Connecting..."),console.log(e)})}setNewCallInfo(){var e=$("body").attr("data-call");e&&this.sendNewCallInfo(e,isCaller)}setUsername(){this.consoleLogger("SingnalR: setting username..."),this.Join()}errorHandler(e){(e.message?alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e.message)):alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e))).set({title:"ZN Vostok"}).set({delay:5e3}),this.consoleLogger(e)}consoleLogger(e){this.isDebugging&&console.log(e)}Join(){var e=uuidv4();this.InvokeProcess(InvokeSender.Join,e,1)}sendNewCallInfo(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.sendNewCallInfo,s,1,e,n)}sendBySignalRToGroup(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.SendToGroup,s,1,e,n)}sendBySignalR(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.SendToUser,s,1,e,n)}sendBySignalRForDel(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.SendToUser,s,1,e,"delmess;,;"+n)}callUser(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.CallUser,s,1,e,n)}SeenMessege(e,n){var s=uuidv4();this.InvokeProcess(InvokeSender.Seen,s,1,e,n)}SeenMessegeForGroup(e,n,s){var t=uuidv4();this.InvokeProcess(InvokeSender.SeenForGroup,t,1,e,n,s)}AnswerCall(e,n){var s=uuidv4(),t=$("body").attr("data-call");this.InvokeProcess(InvokeSender.AnswerCall,s,1,e,n,t)}SendSignal(e,n){var s=uuidv4(),n=$("body").attr("data-call");this.InvokeProcess(InvokeSender.SendSignal,s,1,e,n,isCaller)}HangUp(){var e=uuidv4(),n=$("body").attr("data-call");this.InvokeProcess(InvokeSender.Hangup,e,1,n,isCaller)}InvokeProcess(e,n,s,t,a,o,i,l){var c;switch(1!=s&&2!=s&&3!=s&&4!=s||e!=InvokeSender.SendSignal&&e!=InvokeSender.HangUp&&(c=s+1,setTimeout(function(){InvokeSender.CallUser!=e&&InvokeSender.AnswerCall!=e&&InvokeSender.Hangup!=e&&InvokeSender.SendSignal!=e&&signalRListenerThis.InvokeProcess(e,n,c,t,a,o,i,l)},3e3)),e){case InvokeSender.SendToUser:var r=t,d=a;this.wsconn.invoke("SendMessage",n,r,d);break;case InvokeSender.SendToGroup:r=t,d=a;this.wsconn.invoke("SendMessageToGroup",n,r,d);break;case InvokeSender.SendForDel:r=t;this.wsconn.invoke("SendMessage",n,r,"delmess;,;"+a);break;case InvokeSender.Seen:var u=t,d=a;console.log("SeenMessege","before"),this.wsconn.invoke("SeenMessege",n,u,d),console.log("SeenMessege","after");break;case InvokeSender.SeenForGroup:u=t;this.wsconn.invoke("SeenMessegeForGroup",n,u,a,o);break;case InvokeSender.sendNewCallInfo:var g=t,h=a;this.wsconn.invoke("SendNewCallInfo",n,g,h);break;case InvokeSender.CallUser:1==s&&(beforeCallId=$("body").attr("data-call"),$("body").attr("data-call",n),isCaller=!0);r=t;this.wsconn.invoke("CallUser",n,r,a);break;case InvokeSender.AnswerCall:g=o;this.wsconn.invoke("AnswerCall",n,t,JSON.stringify(a),g);break;case InvokeSender.SendSignal:g=a,h=o;this.wsconn.invoke("SendSignal",n,t,g,h);break;case InvokeSender.Hangup:beforeCallId=$("body").attr("data-call");g=$("body").attr("data-call");this.wsconn.invoke("HangUp",n,g,isCaller);break;case InvokeSender.Join:this.wsconn.invoke("JoinUser",n)}}SendNotConnectAlert(e){alertify.confirm(e,function(e){e&&window.location.reload(),this.sendNotConnectMess=!1}).set({title:"ZN Vostok"}).set("closable",!1).set("labels",{ok:"Refresh",cancel:"Wait for now"})}}var myDubList=[];async function CheckDuplicateInLockBlock(n){try{console.log("CheckDuplicateInLockBlock","begin");var e=await navigator.locks.request("my_resource",e=>pushToDuplicateListAndRun(n));return console.log("CheckDuplicateInLockBlock","end"),e}catch(e){console.log("CheckDuplicateInLockBlock","error:"+e)}}function pushToDuplicateListAndRun(e){return!(0<=myDubList.indexOf(e)||(myDubList.push(e),20<myDubList.length&&myDubList.shift(),0))}const InvokeSender={SendToUser:"SendToUser",SendToGroup:"SendToGroup",sendNewCallInfo:"sendNewCallInfo",SendForDel:"SendForDel",Seen:"Seen",SeenForGroup:"SeenForGroup",SendSignal:"SendSignal",Hangup:"Hangup",CallUser:"CallUser",AnswerCall:"AnswerCall",JoinGuest:"JoinGuest",Join:"Join"};var mySignalRListener=new signalRListener,firstRunFunction=!0,checkSignalrConnectivity=setInterval(function(){checkForRestartSignalR()},7e3);function checkForRestartSignalR(){0==firstRunFunction?"connected"!=mySignalRListener.wsconn.state.toString().toLowerCase()?mySignalRListener=new signalRListener:$(".chat h5.chatpage").html("ZN Vostok"):firstRunFunction=!1}function uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}