var usersProfilePics,signalRListenerThis,beforeCallId="",isCaller=!1;class signalRListener{constructor(){(signalRListenerThis=this).sendNotConnectMess=!1,this.isDebugging=!0,this.hubUrl="/ConnectionHub",this.callingUser={},this.wsconn=(new signalR.HubConnectionBuilder).withUrl(this.hubUrl,signalR.HttpTransportType.WebSockets).withAutomaticReconnect({nextRetryDelayInMilliseconds:e=>($(".chat h5.chatpage").html("ZN Vostok     Connecting..."),checkForRestartSignalR(),1e6)}).configureLogging(signalR.LogLevel.None).build(),this.initializeSignalR(),this.wsconn.onclose(e=>{$(".chat h5.chatpage").html("ZN Vostok     Connecting..."),e?console.error("SignalR: closed with error:",e):console.log("Disconnected"),checkForRestartSignalR()}),this.wsconn.on("OnSetNewName",(e,n,t)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&mySignalRListener.changeNameToNewNameConference(n,t)})}),this.wsconn.on("onGetNewSurvey",(e,a,s)=>{CheckDuplicateInLockBlock(e).then(function(e){var n,t;e&&(n=JSON.parse(s),$(".contact.active").attr("data-id")==a)&&(e={},t="",n.surveyId=n.id,0<$('[data-id="q_'+n.surveyId+'"]').length?(e=allSurveyResults.filter(e=>e.surveyId==n.surveyId)[0],n.answerIndex=e.survey.answerIndex,n.isDone=e.survey.isDone,t=processSurveyInChatString(n),n.firstRes=e.firstRes,n.secondRes=e.secondRes,n.thirdRes=e.thirdRes,n.fourthRes=e.fourthRes,n.fifthRes=e.fifthRes,n.sixthRes=e.sixthRes,n.countAll=e.countAll,n.survey=e.survey,(allSurveyResults=allSurveyResults.filter(e=>e.surveyId!=n.surveyId)).push(n),t&&0<t.length&&$('[data-id="q_'+n.surveyId+'"]').before(t),$('[data-id="q_'+n.surveyId+'"]').eq(1).remove()):(t=processSurveyInChatString(n),allSurveyResults.push({firstRes:0,secondRes:0,thirdRes:0,fourthRes:0,fifthRes:0,sixthRes:0,surveyId:n.id,countAll:0,answerIndex:n.answerIndex,showResultToUser:n.showResultToUser,survey:n}),t&&0<t.length&&$("#lastchat").before(t),setTimeout(function(){$(".chat-pm ul").scrollTop($(".chat-pm ul").get(0).scrollHeight)},300)),processSurveyEvents(n))})}),this.wsconn.on("OnSelectSurveyAnswer",(e,t,a,s,i)=>{CheckDuplicateInLockBlock(e).then(function(e){var n;e&&$(".contact.active").attr("data-id")==i&&s.toLowerCase()!=myUserId.toLowerCase()&&(e=allSurveyResults.filter(e=>e.surveyId==t)[0],1==a?e.firstRes++:2==a?e.secondRes++:3==a?e.thirdRes++:4==a?e.fourthRes++:5==a?e.fifthRes++:6==a&&e.sixthRes++,e.countAll++,console.log("OnSelectSurveyAnswer:",e),(n=processSurveyInChatString(e.survey))&&0<n.length&&$('[data-id="q_'+e.surveyId+'"]').before(n),$('[data-id="q_'+e.surveyId+'"]').eq(1).remove(),processSurveyEvents(e.survey))})}),this.wsconn.on("updateUserList",t=>{var n;$(".chat h5.chatpage").html("ZN Vostok"),t=JSON.parse(t),ul=t,$("#usersLength").text(t.length),$("#usersdata li.user").remove(),$(".contact img").removeClass("online"),$(".contact.active").data("id")&&(ul&&ul.find(e=>e.userId.toLowerCase()==$(".contact.active").data("id").toLowerCase())?($(".pro-small .lastseen").html("Online"),$("li span:not(.seen):not(.delev)").addClass("delev")):(n=$(".contact.active").data("id"),$.post("/Home/UserLastSeen",{contactId:n},function(e){e.lastSeen&&($(".pro-small .lastseen").html(getNiceDateTimeFormat(e.lastSeen)),delevCalc(n,e.lastSeen))}))),$.each(t,function(e){var n="";t[e].username===$("#upperUsername").text()&&(myConnectionId=t[e].connectionId,n="icon-employee"),n||(t[e].inCall,n="icon-smartphone-1"),t[e].inCall,$('.contact[data-id="'+t[e].userId.toLowerCase()+'"] img').addClass("online")})}),this.wsconn.on("callAcceptedNewMember",(e,t,a)=>{CheckDuplicateInLockBlock(e).then(function(e){var n;e&&(console.log("callAcceptedNewMember acceptingUser.userId: "+a.userId+", callid:"+t),a=JSON.parse(a),$("#call-status-lbl").html("Call accepted..."),$(".page3 .text-success").html("In Conference"),mySignalRListener.setConnectionIdToConferenceJson(a),beepring.pause(),beepring.currentTime=0,beepring.volume=0,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),setTimeout(function(){$("#call-status-lbl").html("Connected")},3e3),e=new Date,(n=$("body").attr("data-json"))?((n=JSON.parse(n)).filter(e=>e.userid==a.userId&&e.connectionId==a.connectionId)[0].callid=t,n.push({userid:myUserId,st:e,isCaller:!0,callid:t})):((n=[]).push({userid:myUserId,st:e,isCaller:!0,callid:t}),n.push({userid:a.userId,st:e,isCaller:!1,callid:t,connectionId:a.connectionId})),$("body").attr("data-json",JSON.stringify(n)),createOfferWhenLocalStreamIsReady(a),ifSenderScreenSendAgain())})}),this.wsconn.on("OtherMemberAddCallId",(t,a,s)=>{CheckDuplicateInLockBlock(t).then(function(e){var n;e&&($(".page3 .text-success").html("In Conference"),$(".page3").children().eq(0).children().eq(1).find(".text-success").html("Conference Call"),$(".page3").children().eq(0).children().eq(2).find("h3").html("Participants"),console.log("OtherMemberAddCallId. newCallId: "+t+".  connectionId:"+a+",userId:"+s),e=new Date,(n=$("body").attr("data-json"))?((n=JSON.parse(n)).push({userid:s,st:e,isCaller:!1,callid:t,connectionId:a}),n.push({userid:myUserId,st:e,isCaller:!1,callid:t})):((n=[]).push({userid:myUserId,st:e,isCaller:!1,callid:t}),n.push({userid:s,st:e,isCaller:!1,callid:t,connectionId:a})),$("body").attr("data-json",JSON.stringify(n)),mySignalRListener.LoadUserLogInPage4(s,e),ifSenderScreenSendAgain())})}),this.wsconn.on("OtherMemberCallIdAdded",(n,t)=>{CheckDuplicateInLockBlock(n).then(function(e){e&&($(".page3 .text-success").html("In Conference"),$(".page3").children().eq(0).children().eq(1).find(".text-success").html("Conference Call"),$(".page3").children().eq(0).children().eq(2).find("h3").html("Participants"),console.log("OtherMemberCallIdAdded guid: "+n+", callid:",t),e={userId:(e=mySignalRListener.getOtherUserFromDataJsonByCallid(n)).userid,callid:n,connectionId:e.connectionId},createOfferWhenLocalStreamIsReady(e),ifSenderScreenSendAgain())})}),this.wsconn.on("SendOtherCallIdForShareScreenAllAdded",e=>{CheckDuplicateInLockBlock(e).then(async function(e){e&&await processSecondStepOfShareScreen()})}),this.wsconn.on("callAccepted",(e,n,t)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(console.log("callAccepted acceptingUser.userId: "+t.userId+", callid:",n),t=JSON.parse(t),mySignalRListener.setConnectionIdToConferenceJson(t),$("#call-status-lbl").html("Call accepted..."),beepring.pause(),beepring.currentTime=0,beepring.volume=0,dt1=new Date,videoaudiotimer=setTimeout(timerDisplayFun,1e3),setTimeout(function(){$("#call-status-lbl").html("Connected")},3e3),$(".page2").hide(),$(".page3").show(),createOfferWhenLocalStreamIsReady(t))})}),this.wsconn.on("callDeclined",(e,n,t,a)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(t=JSON.parse(t),console.log("callDeclined callid: "+n),$("#call-status-lbl").html("Call Declined!"),beepring.pause(),beepring.currentTime=0,beepring.volume=0,alertify.error(a,5),setTimeout(function(){$(".hangup").trigger("click")},3e3))})}),this.wsconn.on("IncomingCallAddMember",(r,o,d,c)=>{CheckDuplicateInLockBlock(r).then(function(e){if(e){console.log("IncomingCallAddMember callid: "+o+", CallingUser.userId:"+JSON.parse(d).userId),c=JSON.parse(c);var n=new Date;if("idle"==$("body").attr("data-mode")){isUsedFromVirtualBackground=!1,resetVideoAudioCall(),$(".page3 .text-success").html("In Conference");for(var t=[],a=0;a<c.length;a++){var s,i=c[a],l={userid:i.userid,st:n};i.connectionid?l.connectionId=i.connectionid:0<(s=ul.filter(e=>e.userId==i.userid)).length&&(l.connectionId=s[s.length-1].connectionId),t.push(l),i.userid!=d.userId&&mySignalRListener.LoadUserLogInPage4(i.userid,i.st)}$("body").attr("data-json",JSON.stringify(t)),mySignalRListener.processIncomeCall(r,o,d,!0,c),ringsound.play(),ringsound.volume=.3}else{mySignalRListener.AnswerCall(!1,d,o);e="";try{e=JSON.parse(d).username}catch(e){}dt1=new Date,$(".page4 .txt-timer").eq(0).attr("st",dt1),$(".page4 .txt-timer").eq(1).attr("st",dt1),alertify.error(e+" is calling you now and you missed that!",5)}}})}),this.wsconn.on("incomingCall",(n,t,a,s)=>{CheckDuplicateInLockBlock(n).then(function(e){e&&("idle"==$("body").attr("data-mode")?(resetVideoAudioCall(),$(".page3").children().eq(0).children().eq(1).find(".text-success").html("In Call With"),mySignalRListener.processIncomeCall(n,t,a,s)):mySignalRListener.AnswerCall(!1,a,t))})}),this.wsconn.on("receiveSignal",(e,n,t,a,s)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(t=JSON.parse(t),console.log("receiveSignal callid:"+n+", signalingUser.userId:"+t.userId+", beforecallid:"+s),newSignal(t.connectionId,a,n,t.userId),s)&&mySignalRListener.replaceCallIdInDataJson(s,n)})}),this.wsconn.on("ShareScreenStoped",(e,n)=>{var t,a=$("body").attr("data-json");a&&(t=(a=JSON.parse(a)).filter(e=>e.callid==n&&e.isCaller),a=a.filter(e=>e.callid!=n),$("body").attr("data-json",JSON.stringify(a)),$("#remoteDesktop").attr("data-userid")==t.userid)&&($("#remoteDesktop").srcObject=null,$(".screen.remote").removeClass("active"))}),this.wsconn.on("callEnded",(e,n,t,a)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&(preventToChangePage=!1,$("#call-status-lbl").html("Call ended"),e=new Date-dt1,t=JSON.parse(t),console.log("callEnded callid:"+n+", signalingUser.userId:"+t.userId),0<$('.page4 .persons[data-id="'+t.userId+'"]').length&&3<$(".page4 .persons").length&&$('.page4 .persons[data-id="'+t.userId+'"]').remove(),$.post("/Home/CallLogUpdate",{Status:2,ToUser:t.userId,duration:e/1e3},function(){}),0<$('video [data-userid="'+t.userId+'"]:not(.screen)').length&&$('video [data-userid="'+t.userId+'"]:not(.screen)').parent().appendTo($("#videoDivInvisible")),console.log("SignalR: call with "+t.connectionId+" has ended: "+a),alertify.error(a,5),beepring.pause(),beepring.currentTime=0,beepring.volume=0,closeConnection(n),$("#callstatus").text("Idle"),$("#GotoCall").removeClass("active"))})}),this.wsconn.on("OnSeenMess",(e,n)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&("all"!=n&&0<$("li[data-id="+n+"] span").length?$("li[data-id="+n+"] span"):$("li span:not(.seen)")).addClass("seen")})}),this.wsconn.on("OnSeenMessForGroup",(e,n,t,a)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&a!=myUserId&&("all"!=t&&0<$("li[data-id="+t+"] span").length?$("li[data-id="+t+"] span"):$("li span:not(.seen)")).addClass("seen")})}),this.wsconn.on("ReceiveMessageFromGroup",(e,n,t,a)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&t.split(";;;")[1].toLowerCase()!=myUserId.toLowerCase()&&(console.log("ProcessReceiveMessege","message:"+t+",grpName:"+n+",ContactName:"+a),signalRListenerThis.ProcessReceiveMessege(t,n,a))})}),this.wsconn.on("ReceiveMessage",(e,n)=>{CheckDuplicateInLockBlock(e).then(function(e){e&&signalRListenerThis.ProcessReceiveMessege(n)})}),this.wsconn.on("ReceiveEmoji",(e,n,t,a,s,i,l,r)=>{CheckDuplicateInLockBlock(e).then(function(e){mySignalRListener.processReceiveEmoji(n,t,a,s,i,l,r)})})}changeNameToNewNameConference(e,n){0<$('.persons[data-id="'+n+'"]').length&&$('.persons[data-id="'+n+'"] label').eq(0).html(e)}SetNewName(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.SetNewName,t,1,e,n)}SelectSurveyAnswer(e,n,t){var a=uuidv4();this.InvokeProcess(InvokeSender.SelectSurveyAnswer,a,1,e,n,t)}processReceiveEmoji(e,n,t,a,s,i,l){var r;i.toLowerCase()!=myUserId.toLowerCase()&&(r='<img class="emj-16 '+t+'" src="/emj/'+t+'.svg" />',a?$(".contact.active").attr("data-id")==s?SetEmojiSenderResInChat(e,n.split(","),r,t,l,i):mySignalRListener.processCounterIncreaser(a,s,i):$(".contact.active").attr("data-id")==i?SetEmojiSenderResInChat(e,n.split(","),r,t,l,i):mySignalRListener.processCounterIncreaser(a,s,i))}processCounterIncreaser(e,n,t){var a=(e?$(".contact[data-id="+n.toLowerCase()+"] .text-bg-success"):$(".contact[data-id="+t.toLowerCase()+"] .text-bg-success")).html();a?(a=parseInt(a.replace(" ","").replace("(","").replace(")","")),a++,$(".contact[data-id="+(e?n:t).toLowerCase()+"] .text-bg-success").html(a)):$(".contact[data-id="+(e?n:t).toLowerCase()+"] .text-bg-success").html("1")}LoadUserLogInPage4(n,t){var a,s,e=$('.contact[data-id="'+n+'"]');0<$('.persons[data-id="'+n+'"]').length||(e&&0<e.length?(a=e.find("img").attr("src"),s=e.find("label").eq(0).text().split('"').join(""),e=`
                    <div class="persons" st="`+t+'" data-id="'+n+`">
                        <div>
                            <img src="`+a+`" class="rounded-circle img other" />
                            <label class="other">`+s+`</label>
                        </div>
                        <div>
                            <label class="txt-timer other" st="`+t+`"></label>
                        </div>
                    </div>`,$(".page4 .btn-add-person").before(e)):$.post("/Home/GetUserSimpleByUid",{uid:n},function(e){s=e.name,a=e.profilePic?"/ProfilePics/"+e.profilePic:"/img/person-icon.png";e=`
                        <div class="persons" st="`+t+'" data-id="'+n+`">
                            <div>
                                <img src="`+a+`" class="rounded-circle img other" />
                                <label class="other">`+s+`</label>
                            </div>
                            <div>
                                <label class="txt-timer other" st="`+t+`"></label>
                            </div>
                        </div>`;$(".page4 .btn-add-person").before(e)}))}OtherMemberSendRequirement(e,n,t){console.log("OtherMemberSendRequirement","newcallid:"+e+",targetConnectionIdStr:"+n+",callid:"+t),this.InvokeProcess(InvokeSender.OtherMemberSendRequirement,e,1,n,t)}replaceCallIdInDataJson(n,e){if(t=$("body").attr("data-json")){for(var t,a=(t=JSON.parse(t)).filter(e=>e.callid==n),s=0;s<a.length;s++)a[s].callid=e;$("body").attr("data-json",JSON.stringify(t))}}getOtherUserFromDataJsonByCallid(n){var e=$("body").attr("data-json");return e?(e=JSON.parse(e)).filter(e=>e.callid==n&&e.userid!=myUserId)[0]:null}setConnectionIdToConferenceJson(n){var e=$("body").attr("data-json");e&&((e=JSON.parse(e)).filter(e=>e.userid==n.userId)[0].connectionId=n.connectionId,$("body").attr("data-json",JSON.stringify(e)))}processIncomeCall(e,n,t,a,s){$("#call-status-lbl").html("Call started"),s?(console.log("SignalR: incoming Conference call callid: "+n+", guid:"+e),$("#CallingModal .page1 .text-light").html("Ringing for Conference...")):($("#CallingModal .page1 .text-light").html("Ringing..."),console.log("SignalR: incoming"+(isVideoCall?" video ":" voice ")+"call from callid: "+n+", guid:"+e)),mySignalRListener.callingUser=JSON.parse(t);s=new Date,n=$("body").attr("data-json");if((n=n?JSON.parse(n):[]).push({userid:mySignalRListener.callingUser.userId,st:s,isCaller:!0,callid:e,connectionId:mySignalRListener.callingUser.connectionId}),n.push({userid:myUserId,st:s,isCaller:!1,callid:e}),$("body").attr("data-json",JSON.stringify(n)),isVideoCall=a,ringsound.play(),ringsound.volume=.3,(0==a?initializeUserMediaVoice:initializeUserMediaVideo)(),$(".call-buttons img").removeClass("active"),isVideoCall?($("#CallingModal .video").addClass("active"),$("#CallingModal .video video").show(),$(".two-img").addClass("hideinmobile")):($("#CallingModal .video").removeClass("active"),$("#CallingModal .video video").hide(),$(".two-img").removeClass("hideinmobile")),$(".partner")[0].style.display="none",0==isVideoCall?(localVideo.style.display="none",remoteVideo.style.display="none",$(".partner")[0].style.display="",$("#VideoCallModalLabel").html("Voice Call")):(localVideo.style.display="",remoteVideo.style.display="",$("#VideoCallModalLabel").html("Video Call")),isVideoCall)0==IsCameraPermission&&(IsCameraPermission=JSBridge.getVideoPermission());else try{0==IsMicrophonePermission&&JSBridge.getAudioPermission()}catch{}$("body").attr("data-mode","ringing"),$("#CallingModal .page2").hide(),$("#CallingModal .page3").hide(),$("#CallingModal .page4").hide(),$("#CallingModal .page1").show(),$("#CallingModal").modal("show"),$("#CallingModal img.me").attr("src",myprofilepic),$("#CallingModal label.me").html(myname),$(".page4 .persons").eq(1).attr("data-id",myUserId),$(".page4 .persons").eq(2).attr("data-id",mySignalRListener.callingUser.userId),0<$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"]').length?($("#CallingModal .page1 img.other, #CallingModal .page2 img.other, #CallingModal .page3 img.other").attr("src",$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")),$("#CallingModal .page4 img.other").eq(0).attr("src",$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")),$("#CallingModal h3.other").eq(0).html($('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] label.name').text()),$("#CallingModal .row.blur-img").css("background-image","url('"+$('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] img').attr("src")+"')"),$("#CallingModal label.other").eq(0).html($('.def-mess[data-id="'+mySignalRListener.callingUser.userId+'"] label.name').text())):($("#CallingModal img.other").eq(0).attr("src",""),$("#CallingModal h3.other").eq(0).html(""),$.post("/Home/GetUserPicAndName",{uid:mySignalRListener.callingUser.userId},function(e){$("#CallingModal .page1 img.other, #CallingModal .page2 img.other, #CallingModal .page3 img.other").attr("src",e.profilePic),$("#CallingModal .page4 img.other").eq(0).attr("src",e.profilePic),$("#CallingModal h3.other").eq(0).html(e.firstName+" "+e.lastName),$("#CallingModal .row.blur-img").css("background-image","url('"+e.profilePic+"')"),$("#CallingModal label.other").eq(0).html(e.firstName+" "+e.lastName)}))}ProcessReceiveMessege(n,e,t){notifring.play();var a,s,i=(n=ProcessLinkMess(n)).split(";;;")[1],l="";if(t&&(l=t.split(";")[1],t=t.split(";")[0]),n.startsWith("delmess;,;"))e?$(".contact[data-id="+e.toLowerCase()+"]").hasClass("active")&&(s=(a=n.replace("delmess;,;","").split(";;;")[0]).split(","),$.each(s,function(e,n){e=s[e];$("ul li[data-id="+e+"]").remove()})):$(".contact[data-id="+i+"]").hasClass("active")&&(a=n.replace("delmess;,;","").split(";;;")[0],$("ul li[data-id="+a+"]").remove());else if(n.startsWith("customNotif:"))try{var r=n.split(";;;")[3],o=n.split(";;;")[2],d=n.split(";;;")[4];JSBridge.setCustomNotification(o,d,parseInt(r))}catch{}else{if(e)null==(u=$(".contact[data-id="+e.toLowerCase()+"] .text-bg-success").html())&&this.appendNewContactById(e,!0);else if(null==(u=$(".contact[data-id="+i.toLowerCase()+"] .text-bg-success").html()))return void this.appendNewContactById(i);o=(e||i).toLowerCase(),d="";0<$(".contact.active").length&&(d=$(".contact.active").attr("data-id")),u?(g=0,""!=(u=u.replace(" ","").replace("(","").replace(")",""))&&(g=parseInt(u)),g++,d!=o&&$(".contact[data-id="+o+"] .text-bg-success").html(g)):d!=o&&$(".contact[data-id="+o+"] .text-bg-success").html("1");try{r=n.split(";;;")[3];JSBridge.setNotification("you have new message",r)}catch{}if(d==o){var c=new Date,u=(n=decodeHtml(n)).split(";;;")[0],g=n.split(";;;")[2],m=(a=n.split(";;;")[3],n.split(";;;")[4]),h="",p=l?"/ProfilePics/thumbnails/"+l:e?"/img/group-icon.png":"/img/person-icon.png",v=0;if((g=ProcessMapLinkLatLon(g))&&g.startsWith("@@@announcementData:")){g=g.substring("@@@announcementData:".length);try{v=parseInt(g.substring(0,g.indexOf(":"))),g=g.substring(g.indexOf(":")+1)}catch(e){}}if("isfile"==u){var S=g.split(",;,")[0].split(";"),I="";1<g.split(",;,").length&&(I=g.split(",;,")[1]);for(var C=0;C<S.length;C++){h=(h+='<li class="from-other" data-id="'+a+'" >')+(e&&t!=lastUserIngroup?"<div class='float-start'><img src='"+p+"' class='img-pro' /></div><div class='float-start name'>"+t+"</div>":""),I&&(h+='<div class="newcard" data-id="'+(m||"")+`" >
                          <div class="card-header" `+ForwardSenderId(I)+">"+I.split(",@,")[0]+"</div>");var f=document.createTextNode(S[C].split("\\\\").join("\\"));S[C]=f.textContent,IsImage(removeCaptionFromFilename(S[C]))?h+='<label><a href="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up" class="js-smartPhoto img-tag"><div><img  class="fupload" src="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up&th=true" /></div><div>'+SimpleFileName(S[C])+"</div></a></label>":IsAudio(removeCaptionFromFilename(S[C]))?h+='<label><div><audio controls src="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up" ></audio></div><div> '+SimpleFileName(S[C])+"</div></label>":IsVideo(removeCaptionFromFilename(S[C]))?h+='<label><div><video controls  ><source src="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up" ></video></div><div> '+SimpleFileName(S[C])+"</div></label>":IsPdfOrDoc(removeCaptionFromFilename(S[C]))?h+='<label><a href="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up" target="_blank" ><div><img class="docpdfimg" src="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C].substring(0,removeCaptionFromFilename(S[C]).lastIndexOf(".")))+'.jpg&fileType=up&th=true" /></div><div>'+SimpleFileName(S[C])+"</div></a></label>":h+='<label><a href="/Home/GetFile?fileName='+removeCaptionFromFilename(S[C])+'&fileType=up" target="_blank" ><div><img src="/img/file-icon.png" /></div><div>'+SimpleFileName(S[C])+"</div></a></label>",I&&(h+="</div>"),h+='</li><li  class="from-other"><div class="date">'+getNiceDateTimeFormat(c)+"</div></li>",t&&(lastUserIngroup=t)}}else h+='<li class="from-other"  data-id="'+a+'" >'+(e&&t!=lastUserIngroup?"<div class='float-start'><img src='"+p+"' class='img-pro' /></div><div class='float-start name'>"+t+"</div>":"")+(0<=g.indexOf(",;,")?'<div class="newcard" data-id="'+(m||"")+`" >
                          <div class="card-header">`+g.split(",;,")[0]+"</div><label "+checkRtlOfText(g.split(",;,")[1])+">"+textToWrite(g.split(",;,")[1])+"</label></div>":"<label"+checkRtlOfText(g)+">"+textToWrite(g)+"</label>")+'</li><li  class="from-other"><div class="date">'+getNiceDateTimeFormat(u)+"</div></li>",t&&(lastUserIngroup=t);e?this.SeenMessegeForGroup(a,i,e):this.SeenMessege(a,i),setTimeout(function(){var e=n.split(";;;")[3];e&&$('li[data-id="'+e+'"]').remove(),$("#lastchat").before(h),0<v&&removeLiAfterSecond(a,1e3*(v+1)),$(".locationdata:not(.proc)").on("click",function(){var e=$(this).attr("data-id");locationdataProcess(e)}),$(".locationdata:not(.proc)").addClass("proc")},500),$("li .newcard:not(.card) .card-header").on("click",function(){var e=$(this).parent().data("id");$(".chat-pm ul").scrollTop($('[data-id="'+e+'"]').get(0).offsetTop-90),$('[data-id="'+e+'"]').eq(0).css("background","black"),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","transparent")},500),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","black")},1e3),setTimeout(function(){$('[data-id="'+e+'"]').eq(0).css("background","transparent")},1500)}),setTimeout(function(){$(".chat-pm ul").scrollTop($(".chat-pm ul").get(0).scrollHeight),$("li .newcard:not(.card)").addClass("card"),loadForSelectLi()},510),0<$(".js-smartPhoto:not(.proc)").length&&(new SmartPhoto(".js-smartPhoto:not(.proc)"),$(".js-smartPhoto:not(.proc)").addClass("proc"))}}}appendNewContactById(e,n){$.post("/Home/GetAccounts",{searchKey:e},function(e){if(0!=e.length){$(".no-mess-contact").hide();for(var n=0;n<e.length;n++){var t=e[n].contactName||e[n].userName,a=e[n].profilePic?"/ProfilePics/thumbnails/"+e[n].profilePic:e[n].isGroup?"/img/group-icon.png":"/img/person-icon.png",a='<div class="mess row contact new-def-mess def-mess" minid="'+e[n].minid+'" data-id="'+e[n].userId+`">
                                    <div class="col-12 d-inline px-3">
                                        <div class="float-start">
                                            <img src="`+a+`" class="img-pro online">
                                        </div>
                                        <div class="float-start text-start px-2">
                                            <div class="pro">
                                                    <label class="name">`+t+`</label>
                                                    <label class="company">`+e[n].companyTitle+`</label>
                                                    <label class="role">`+e[n].position+`</label>
                                            </div>
                                        </div>
                                        <div class="float-end chat-num">
                                            <label class="badge text-bg-success">1</label>
                                        </div>
                                    </div>
                                </div>`;$(".contacts").children().first().before(a),$(".new-def-mess").on("click",function(){$(".contact").removeClass("new-def-mess"),$(".contact").removeClass("active"),$(this).addClass("active");var e=$(this).data("id");$(".loading").show(),$(this).data("id");$.post("/Home/GetContactMessage",{minId:"0",contactId:e},function(e){$(".loading").hide(),null==e||0==e.length?SetEmptyMessage():SetResultOfMessage(e)})}),$(".new-def-mess").addClass("def-mess").removeClass("new-def-mess")}}})}initializeSignalR(){this.wsconn.start().then(()=>{$(".chat h5.chatpage").html("ZN Vostok"),console.log("SignalR: Connected"),this.setUsername(myusername),this.setNewCallInfo()}).catch(e=>{$(".chat h5.chatpage").html("ZN Vostok     Connecting..."),console.log(e)})}setNewCallInfo(){if(e=$("body").attr("data-json"))for(var e=JSON.parse(e),n=0;n<e.length;n++)e[n].userid!=myUserId&&this.sendNewCallInfo(e[n].callid,e[n].isCaller,myUserId)}setUsername(){this.consoleLogger("SingnalR: setting username..."),this.Join()}errorHandler(e){(e.message?alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e.message)):alertify.alert("<h4>Error Occurred</h4></br>Error Info: "+JSON.stringify(e))).set({title:"ZN Vostok"}).set({delay:5e3}),this.consoleLogger(e)}consoleLogger(e){this.isDebugging&&console.log(e)}shareScreenStoped(e){var n=uuidv4();this.InvokeProcess(InvokeSender.ShareScreenStoped,n,1,e)}Join(){var e=uuidv4();this.InvokeProcess(InvokeSender.Join,e,1)}sendNewCallInfo(e,n,t){var a=uuidv4();this.InvokeProcess(InvokeSender.sendNewCallInfo,a,1,e,n,t)}sendBySignalRToGroup(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.SendToGroup,t,1,e,n)}sendBySignalR(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.SendToUser,t,1,e,n)}sendBySignalRForDel(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.SendToUser,t,1,e,"delmess;,;"+n)}callUser(e,n){var t=uuidv4(),a=t,a=(this.InvokeProcess(InvokeSender.CallUser,t,1,a,e,n),$("body").attr("data-json"));(a?a=JSON.parse(a):((a=[]).push({userid:myUserId,st:dt1,isCaller:!0,callid:t,connectionId:mySignalRListener.wsconn.connectionId}),a)).push({userid:e,st:dt1,isCaller:!1,callid:t}),$("body").attr("data-json",JSON.stringify(a))}SendForNewSurvey(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.SendForNewSurvey,t,1,e,n)}SeenMessege(e,n){var t=uuidv4();this.InvokeProcess(InvokeSender.Seen,t,1,e,n)}SeenMessegeForGroup(e,n,t){var a=uuidv4();this.InvokeProcess(InvokeSender.SeenForGroup,a,1,e,n,t)}AnswerCallNewMember(e,n,t){var a=uuidv4(),s="",s=t||mySignalRListener.getCallidByUserId(n.userId);this.InvokeProcess(InvokeSender.AnswerCallNewMember,a,1,e,n,s)}AnswerCall(e,n,t){var a=uuidv4(),s="",s=t||mySignalRListener.getCallidByUserId(n.userId);this.InvokeProcess(InvokeSender.AnswerCall,a,1,e,n,s)}getFirstCurrentCallid(){if(e=$("body").attr("data-json")){var e=(e=JSON.parse(e)).filter(e=>e.callid);if(e&&0<e.length)return e[0].callid}return""}getCallidByUserId(n){if(e=$("body").attr("data-json")){var e=(e=JSON.parse(e)).filter(e=>e.userid==n&&e.callid&&!e.shareScreen);if(e&&0<e.length)return e[0].callid}return""}NewMemberAndCaller(e){var n=uuidv4(),t=mySignalRListener.getFirstCurrentCallid(),t=(this.InvokeProcess(InvokeSender.NewMemberAndCaller,n,1,e,t),$("body").attr("data-json"));(t?t=JSON.parse(t):((t=[]).push({userid:myUserId,st:dt1,isCaller:!0,callid:n}),t)).push({userid:e.userId,st:dt1,isCaller:!1,callid:n}),$("body").attr("data-json",JSON.stringify(t))}SendOtherCallIdForShareScreen(e){var n=uuidv4();this.InvokeProcess(InvokeSender.SendOtherCallIdForShareScreen,n,1,e)}SendSignal(e,n){var t=this.getLocalIsCaller(n),a=uuidv4();console.log("InvokeSender.SendSignal callid:"+n+" , guid:"+a+", localIsCaller:"+t),this.InvokeProcess(InvokeSender.SendSignal,a,1,e,n,t)}getLocalIsCaller(n){var e=$("body").attr("data-json");return!!e&&(e=JSON.parse(e)).filter(e=>e.callid==n&&e.userid==myUserId)[0].isCaller}sendEmojiBySignalR(e,n,t,a,s){var i=uuidv4();this.InvokeProcess(InvokeSender.sendEmoji,i,1,e,n,t,a,s)}HangUp(){var e=uuidv4();if(n=$("body").attr("data-json"))for(var n=JSON.parse(n),t=0;t<n.length;t++)n[t].userid==myUserId&&this.InvokeProcess(InvokeSender.Hangup,e,1,n[t].callid,n[t].isCaller);remoteVideo.removeAttribute("data-userid")}InvokeProcess(e,n,t,a,s,i,l,r){switch(e){case InvokeSender.SetNewName:var o=s;this.wsconn.invoke("SetNewName",n,a,o);break;case InvokeSender.SelectSurveyAnswer:var d=a,c=s,u=i;this.wsconn.invoke("SelectSurveyAnswer",n,parseInt(d),parseInt(c),o,u);break;case InvokeSender.SendForNewSurvey:d=a,u=s;this.wsconn.invoke("SendForNewSurvey",n,d,u);break;case InvokeSender.ShareScreenStoped:this.wsconn.invoke("ShareScreenStoped",n,JSON.stringify(a));break;case InvokeSender.SendOtherCallIdForShareScreen:this.wsconn.invoke("SendOtherCallIdForShareScreen",n,JSON.stringify(a));break;case InvokeSender.SendToUser:var g=a,m=s;this.wsconn.invoke("SendMessage",n,g,m);break;case InvokeSender.SendToGroup:g=a,m=s;this.wsconn.invoke("SendMessageToGroup",n,g,m);break;case InvokeSender.SendForDel:g=a;this.wsconn.invoke("SendMessage",n,g,"delmess;,;"+s);break;case InvokeSender.Seen:var h=a,p=s;console.log("SeenMessege","before"),this.wsconn.invoke("SeenMessege",n,h,p),console.log("SeenMessege","after");break;case InvokeSender.SeenForGroup:h=a;this.wsconn.invoke("SeenMessegeForGroup",n,h,s,i);break;case InvokeSender.sendNewCallInfo:var v=a,S=s,g=i;this.wsconn.invoke("SendNewCallInfo",n,v,S,g);break;case InvokeSender.CallUser:v=a,g=s;this.wsconn.invoke("CallUser",n,v,g,i);break;case InvokeSender.AnswerCallNewMember:var I=a,C=s,v=i;this.wsconn.invoke("AnswerCallNewMember",n,I,JSON.stringify(C),v);break;case InvokeSender.AnswerCall:I=a,C=s,v=i;this.wsconn.invoke("AnswerCall",n,I,JSON.stringify(C),v);break;case InvokeSender.NewMemberAndCaller:C=a,v=s;this.wsconn.invoke("NewMemberAndCaller",n,JSON.stringify(C),v);break;case InvokeSender.SendSignal:var c=a,v=s,S=i,o=mySignalRListener.getBeforeCallIdAndRemoveThat(v);this.wsconn.invoke("SendSignal",n,c,v,S,o);break;case InvokeSender.Hangup:v=a;this.wsconn.invoke("HangUp",n,v,s);break;case InvokeSender.Join:this.wsconn.invoke("JoinUser",n);break;case InvokeSender.OtherMemberSendRequirement:v=s;this.wsconn.invoke("OtherMemberSendRequirement",n,a,v);break;case InvokeSender.sendEmoji:d=a,u=s,m=i,p=l,h=$('.contact[data-id="'+p+'"]').hasClass("grp");this.wsconn.invoke("sendEmoji",n,d,u,m,p,h,r)}}SendNotConnectAlert(e){alertify.confirm(e,function(e){e&&window.location.reload(),this.sendNotConnectMess=!1}).set({title:"ZN Vostok"}).set("closable",!1).set("labels",{ok:"Refresh",cancel:"Wait for now"})}getBeforeCallIdAndRemoveThat(n){var e=$("body").attr("data-json"),t="";return e&&(e=(e=JSON.parse(e)).filter(e=>e.callid==n))&&0<e.length&&(t=e[0].beforecallid,e[0].beforecallid=null),t}}var myDubList=[];async function CheckDuplicateInLockBlock(n){try{console.log("CheckDuplicateInLockBlock","begin");var e=await navigator.locks.request("my_resource",e=>pushToDuplicateListAndRun(n));return console.log("CheckDuplicateInLockBlock","end"),e}catch(e){console.log("CheckDuplicateInLockBlock","error:"+e)}}function pushToDuplicateListAndRun(e){return!(0<=myDubList.indexOf(e)||(myDubList.push(e),20<myDubList.length&&myDubList.shift(),0))}const InvokeSender={SetNewName:"SetNewName",SelectSurveyAnswer:"SelectSurveyAnswer",SendForNewSurvey:"SendForNewSurvey",ShareScreenStoped:"ShareScreenStoped",SendToUser:"SendToUser",SendToGroup:"SendToGroup",sendNewCallInfo:"sendNewCallInfo",SendForDel:"SendForDel",Seen:"Seen",SeenForGroup:"SeenForGroup",SendSignal:"SendSignal",SendOtherCallIdForShareScreen:"SendOtherCallIdForShareScreen",Hangup:"Hangup",CallUser:"CallUser",AnswerCall:"AnswerCall",AnswerCallNewMember:"AnswerCallNewMember",NewMemberAndCaller:"NewMemberAndCaller",JoinGuest:"JoinGuest",Join:"Join",OtherMemberSendRequirement:"OtherMemberSendRequirement",sendEmoji:"sendEmoji"};var mySignalRListener=new signalRListener,firstRunFunction=!0,checkSignalrConnectivity=setInterval(function(){checkForRestartSignalR()},7e3);function checkForRestartSignalR(){0==firstRunFunction?"connected"!=mySignalRListener.wsconn.state.toString().toLowerCase()?mySignalRListener=new signalRListener:$(".chat h5.chatpage").html("ZN Vostok"):firstRunFunction=!1}function uuidv4(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function decodeHtml(e){var n=document.createElement("textarea");return n.innerHTML=e,n.value}