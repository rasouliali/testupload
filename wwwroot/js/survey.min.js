var allSurveyResults=[];function getSurvey(e,a){$.post("/Home/GetSurvey",{fromuser:e,selectedContact:a},function(e){e&&(e.surveys&&LoadSurvey(e.surveys),e.surveyResults)&&LoadsurveyResults(e.surveyResults,e.surveys)})}var UserSurvay=[];function surveyCreator(){$("#survey_btn").on("click",function(){$.post("/Home/GetUserSurvay",null,function(e){UserSurvay=e;for(var a="",s=0;s<e.length;s++){var r=e[s];a+="<tr><td><button type='button' class='btn btn-primary' data-id='"+r.id+"'>Edit</button></td><td>"+r.title+"</td><td>"+r.countOfAnswer+"</td><td>"+r.isActive+"</td></tr>"}$("#CreateSurvayModal .list table tbody").html(a),$("#CreateSurvayModal .list button").on("click",function(){var a=$(this).attr("data-id"),e=UserSurvay.filter(e=>e.id==a)[0];$("#CreateSurvayModal .page").hide(),$("#CreateSurvayModal .addedit").show(),e&&(e.id&&$("#CreateSurvayModal .addedit #Id").val(e.id),$("#CreateSurvayModal .addedit #Title").val(e.title),e.showResultToUser?$("#CreateSurvayModal .addedit #ShowResultToUser").prop("checked",!0):$("#CreateSurvayModal .addedit #ShowResultToUser").prop("checked",!1),$("#CreateSurvayModal .addedit #Question").val(e.question),$("#CreateSurvayModal .addedit #CountOfAnswer").val(e.countOfAnswer),e.endTime&&$("#CreateSurvayModal .addedit #EndTime").val(e.endTime),AnswerVisibility(e,e.countOfAnswer),e.isActive?$("#CreateSurvayModal .addedit #IsActive").prop("checked",!0):$("#CreateSurvayModal .addedit #IsActive").prop("checked",!1))})}),$("#CreateSurvayModal .page").hide(),$("#CreateSurvayModal .list").show(),$("#CreateSurvayModal .list table tbody").html(""),$("#CreateSurvayModal").modal("show")})}function AnswerVisibility(e,a){0<a?($("#CreateSurvayModal .addedit #Answer1").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer1").val(e.answer1)):($("#CreateSurvayModal .addedit #Answer1").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer1").val("")),1<a?($("#CreateSurvayModal .addedit #Answer2").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer2").val(e.answer2)):($("#CreateSurvayModal .addedit #Answer2").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer2").val("")),2<a?($("#CreateSurvayModal .addedit #Answer3").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer3").val(e.answer3)):($("#CreateSurvayModal .addedit #Answer3").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer3").val("")),3<a?($("#CreateSurvayModal .addedit #Answer4").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer4").val(e.answer4)):($("#CreateSurvayModal .addedit #Answer4").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer4").val("")),4<a?($("#CreateSurvayModal .addedit #Answer5").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer5").val(e.answer5)):($("#CreateSurvayModal .addedit #Answer5").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer5").val("")),5<a?($("#CreateSurvayModal .addedit #Answer6").parent().removeClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer6").val(e.answer6)):($("#CreateSurvayModal .addedit #Answer6").parent().addClass("d-none"),e&&$("#CreateSurvayModal .addedit #Answer6").val(""))}function LoadsurveyResults(e,a){if(e||0!=e.length)if(0<allSurveyResults.length){for(var s=0;s<e.length;s++)surveyResult=e[s],allSurveyResults.push(surveyResult);for(s=0;s<a.length;s++)survey=a[s],(r=allSurveyResults.filter(e=>e.surveyId==survey.id))&&0<r.length?(r[0].showResultToUser=survey.showResultToUser,r[0].survey=survey):allSurveyResults.push({firstRes:0,secondRes:0,thirdRes:0,fourthRes:0,fifthRes:0,sixthRes:0,surveyId:survey.id,countAll:0,answerIndex:survey.answerIndex,showResultToUser:survey.showResultToUser,survey:survey})}else{for(s=0;s<e.length;s++)surveyResult=e[s],allSurveyResults.push(surveyResult);for(var r,s=0;s<a.length;s++)survey=a[s],(r=allSurveyResults.filter(e=>e.surveyId==survey.id))&&0<r.length?(r[0].showResultToUser=survey.showResultToUser,r[0].survey=survey):allSurveyResults.push({firstRes:0,secondRes:0,thirdRes:0,fourthRes:0,fifthRes:0,sixthRes:0,surveyId:survey.id,countAll:0,answerIndex:survey.answerIndex,showResultToUser:survey.showResultToUser,survey:survey})}}function LoadSurvey(e){if(e||0!=e.length)if(0==$(".chat-pm ul li").length)setTimeout(function(){LoadSurvey(e)},300);else{for(var a="",s=0;s<e.length;s++)a+=processSurveyInChatString(e[s]);a&&0<a.length&&$("#lastchat").before(a),setTimeout(function(){$(".chat-pm ul").scrollTop($(".chat-pm ul").get(0).scrollHeight)},300);for(s=0;s<e.length;s++)processSurveyEvents(e[s])}}function processSurveyEvents(e){0==e.isDone?$('[name="answer'+e.id+'"]:not(.proc)').on("click",function(){ProcessDoneSurvey($(this),!1)}):($('[data-id="q_'+e.id+'"] input:not(.proc)').attr("disabled",""),ProcessDoneSurvey($('[name="answer'+e.id+'"]'),!0,e.answerIndex)),$('[name="answer'+e.id+'"]:not(.proc)').addClass("proc")}function processSurveyInChatString(e){var a="";return a+='<li class="from-other survey" data-id="q_'+e.id+`">
        <label>
	<label class="w-100">
		`+e.question+(e.showResultToUser?" [Open to show result to others]":"[Do not show result to others]")+`
	</label>
	<label class="w-100" for="answer`+e.id+`_1">
		`+e.answer1+`
		<input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_1" />
	</label>`,1<e.countOfAnswer&&(a+='<label class="w-100" for="answer'+e.id+`_2">
		        `+e.answer2+`
		        <input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_2" />
	        </label>`),2<e.countOfAnswer&&(a+='<label class="w-100" for="answer'+e.id+`_3">
		        `+e.answer3+`
		        <input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_3" />
	        </label>`),3<e.countOfAnswer&&(a+='<label class="w-100" for="answer'+e.id+`_4">
		        `+e.answer4+`
		        <input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_4" />
	        </label>`),4<e.countOfAnswer&&(a+='<label class="w-100" for="answer'+e.id+`_5">
		        `+e.answer5+`
		        <input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_5" />
	        </label>`),5<e.countOfAnswer&&(a+='<label class="w-100" for="answer'+e.id+`_6">
		        `+e.answer6+`
		        <input type="radio" name="answer`+e.id+'" id="answer'+e.id+`_6" />
	        </label>`),a+="</label></li>"}function ProcessDoneSurvey(e,a,s){var r,t,n=0,d=e.eq(0).attr("name").replace("answer",""),e=($('[data-id="q_'+d+'"] input').attr("disabled",""),a||(n=e.attr("id").replace("answer"+d+"_",""),$.post("/Home/SetSurveyResult",{surveyId:d,choiceIndex:n},function(){})),s&&$("#answer"+d+"_"+s).prop("checked",!0),allSurveyResults.filter(e=>e.surveyId==d)[0]);e.showResultToUser&&(s=e.countAll+(a?0:1),r=0==(r=e.countAll+(a?0:1))?1:r,t=e.firstRes+(1==n?1:0),$('[for="answer'+d+'_1"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*1e4)/100+"%) ]</sp>"),t=e.secondRes+(2==n?1:0),0<$('[for="answer'+d+'_2"]').length&&$('[for="answer'+d+'_2"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*1e4)/100+"%) ]</sp>"),t=e.thirdRes+(3==n?1:0),0<$('[for="answer'+d+'_3"]').length&&$('[for="answer'+d+'_3"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*100)/100+"%) ]</sp>"),t=e.fourthRes+(4==n?1:0),0<$('[for="answer'+d+'_4"]').length&&$('[for="answer'+d+'_4"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*1e4)/100+"%) ]</sp>"),t=e.fifthRes+(5==n?1:0),0<$('[for="answer'+d+'_5"]').length&&$('[for="answer'+d+'_5"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*1e4)/100+"%) ]</sp>"),t=e.sixthRes+(6==n?1:0),0<$('[for="answer'+d+'_6"]').length&&$('[for="answer'+d+'_6"]').append('<sp class="red">['+t+" of "+s+" ("+Math.round(t/r*1e4)/100+"%) ]</sp>"),loadForSurveySelectLi(),a||(mySignalRListener.SelectSurveyAnswer(d,n,$(".contact.active").attr("data-id")),(e=allSurveyResults.filter(e=>e.surveyId==d)[0]).isDone=!0,e.answerIndex=n,e.survey.isDone=!0,1==(e.survey.answerIndex=n)?e.firstRes++:2==n?e.secondRes++:3==n?e.thirdRes++:4==n?e.fourthRes++:5==n?e.fifthRes++:6==n&&e.sixthRes++,e.countAll++,console.log("after set survey:",e)))}function loadForSurveySelectLi(){var s=0;$(".chat-pm li.survey").unbind("mousedown"),$(".chat-pm li.survey").unbind("mouseup"),$(".chat-pm li.survey").unbind("mouseleave"),$(".chat-pm li.survey").unbind("mouseleave"),$(".chat-pm li.survey").unbind("touchstart"),$(".chat-pm li.survey").unbind("touchend"),$(".chat-pm li.survey").on("mousedown touchstart",function(e){var a=$(this);SelectLi&&"mousedown"==e.type&&survey_must_be_selected(a),s=setTimeout(function(){survey_must_be_selected(a)},1e3)}).on("mouseup mouseleave touchend",function(){clearTimeout(s)})}function survey_must_be_selected(e){e.addClass("selected");var a=(a=e.attr("data-id")).replace("q_","");$(".context-menu .origin").addClass("d-none"),$(".context-menu").removeClass("d-none"),$(".context-menu > div.survey-btn").removeClass("d-none"),$(".context-menu > .survey-btn").unbind("click"),$(".context-menu > .survey-btn").on("click",function(){$.post("/Home/SurveyUserReslt",{surveyId:a},function(e){$(this).addClass("d-none");for(var a="<div class='survey-result'><div class='w-100'><div class='answer ans1'>First</div>"+(1<e.survey.countOfAnswer?"<div class='answer ans2'>Second</div>":"")+(2<e.survey.countOfAnswer?"<div class='answer ans3'>Third</div>":"")+(3<e.survey.countOfAnswer?"<div class='answer ans4'>Fourth</div>":"")+(4<e.survey.countOfAnswer?"<div class='answer ans5'>Fifth</div>":"")+(5<e.survey.countOfAnswer?"<div class='answer ans6'>Sixth</div>":"")+"<div class='answer all selected'>All</div><div class='answer close-survey'>&times;</div></div>",s=0;s<e.surveyResults.length;s++)a+="<div class='w-100 person ans"+e.surveyResults[s].answerIndex+"'>"+e.surveyResults[s].fullName+"</div>";a+="<div class='w-100 person d-none anyone'>[No one Choose this Item]</div>",$(".context-menu").append(a),$(".context-menu .survey-result .answer").on("click",function(){var e=$(this).attr("class").replace("answer ","");$(".context-menu .survey-result .answer").removeClass("selected"),$(this).addClass("selected"),"all"!=e&&"close-survey"!=e?($(".context-menu .person").hide(),$(".context-menu .person.anyone").addClass("d-none"),$(".context-menu .person."+e).show(),0==$(".context-menu .person."+e).length&&($(".context-menu .person.anyone").removeClass("d-none"),$(".context-menu .person.anyone").show())):"all"==e?($(".context-menu .person").show(),$(".context-menu .person.anyone").hide()):($(".context-menu .survey-result").remove(),$(".context-menu .origin").removeClass("d-none"),$(".context-menu").addClass("d-none"),$(".chat-pm li.survey").removeClass("selected"),$(".context-menu > .survey-btn").addClass("d-none"))})})})}$(document).ready(function(){$("#CreateSurvayModal .addedit #CountOfAnswer").on("change",function(){AnswerVisibility(null,$(this).val())}),$("#btn-add-survay").on("click",function(){$("#CreateSurvayModal .page").hide(),$("#CreateSurvayModal .addedit").show(),$("#CreateSurvayModal .addedit input").val(""),$("#CreateSurvayModal .addedit #IsActive").prop("checked",!0)}),$("#CancelAddEditSurvay").on("click",function(){$("#CreateSurvayModal .page").hide(),$("#CreateSurvayModal .list").show()}),$("#CancelSurvay").on("click",function(){$("#CreateSurvayModal").modal("hide")}),$("#SaveSurvay").on("click",function(){var e={title:$("#CreateSurvayModal #Title").val(),showResultToUser:$("#CreateSurvayModal #ShowResultToUser").prop("checked"),question:$("#CreateSurvayModal #Question").val(),countOfAnswer:$("#CreateSurvayModal #CountOfAnswer").val(),answer1:$("#CreateSurvayModal #Answer1").val(),answer2:$("#CreateSurvayModal #Answer2").val(),answer3:$("#CreateSurvayModal #Answer3").val(),answer4:$("#CreateSurvayModal #Answer4").val(),answer5:$("#CreateSurvayModal #Answer5").val(),answer6:$("#CreateSurvayModal #Answer6").val(),endTime:$("#CreateSurvayModal #EndTime").val(),isActive:$("#CreateSurvayModal #IsActive").prop("checked"),id:$("#CreateSurvayModal #Id").val(),toGroups:$(".contact.active").attr("data-id")};e.id||(e.id=0),$.post("/Home/AddEditSurvay",e,function(e){$("#CreateSurvayModal").modal("hide"),mySignalRListener.SendForNewSurvey(e.id,$(".contact.active").attr("data-id"))})})});